# Story 03.02: Captura e Validação de Boletos

## Status
**Current Status:** Draft  
**Epic:** 03 - Smart Payment Automation  
**Priority:** High  
**Estimated Effort:** 5 days  
**Dependencies:** Biblioteca OCR, AI Categorization, painel frontend

---

## Story

**As a** usuário do AegisWallet,  
**I want** capturar boletos através de foto, PDF ou código de barras e ter validação automática dos dados,  
**so that** eu nunca mais precise digitar dados de boletos manualmente e tenha confiança na precisão dos pagamentos.

---

## Acceptance Criteria

1. [ ] Upload de PDF/imagem e leitura de código de barras com OCR
2. [ ] Validação de dígito verificador, data de vencimento e valor
3. [ ] Sugestão de categorização e vínculo a conta recorrente
4. [ ] Confirmar pagamento automático com antecedência configurável
5. [ ] Alertar usuário em caso de boletos suspeitos ou divergentes
6. [ ] Taxa de leitura correta ≥95% para boletos padrão FEBRABAN
7. [ ] Tempo de processamento <3 segundos por boleto
8. [ ] Suporte a boletos de concessionárias, bancos e órgãos públicos

---

## Tasks / Subtasks

- [ ] **Sistema de Captura Multi-formato** (AC: 1)
  - [ ] Implementar upload de imagens (JPG, PNG, HEIC)
  - [ ] Adicionar suporte a PDF com múltiplas páginas
  - [ ] Integrar câmera para captura direta de código de barras
  - [ ] Implementar pré-processamento de imagem (rotação, contraste)
  - [ ] Configurar compressão automática para otimizar upload

- [ ] **Engine OCR e Validação** (AC: 2, 6)
  - [ ] Integrar biblioteca OCR (Tesseract ou Google Vision)
  - [ ] Implementar parser para código de barras FEBRABAN
  - [ ] Adicionar validação de dígito verificador
  - [ ] Criar validação de formato de data e valor
  - [ ] Implementar detecção de boletos vencidos

- [ ] **Sistema de Categorização Inteligente** (AC: 3)
  - [ ] Criar base de dados de beneficiários comuns
  - [ ] Implementar matching com contas recorrentes
  - [ ] Adicionar sugestão de categoria baseada em beneficiário
  - [ ] Configurar aprendizado com histórico do usuário
  - [ ] Implementar confiança de categorização

- [ ] **Agendamento e Automação** (AC: 4)
  - [ ] Implementar agendamento automático baseado em vencimento
  - [ ] Configurar antecedência padrão (2 dias úteis)
  - [ ] Adicionar opção de pagamento imediato
  - [ ] Criar regras de pagamento por categoria
  - [ ] Implementar confirmação antes do agendamento

- [ ] **Sistema de Alertas e Validação** (AC: 5, 7, 8)
  - [ ] Detectar boletos com valores muito altos ou baixos
  - [ ] Alertar para boletos de beneficiários desconhecidos
  - [ ] Validar consistência com histórico de pagamentos
  - [ ] Implementar blacklist de beneficiários suspeitos
  - [ ] Configurar alertas para boletos próximos ao vencimento

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/lib/banking/pixApi.ts` - APIs de pagamento existentes
- `src/components/` - Componentes UI base
- `supabase/storage/` - Storage para arquivos

**Novos Arquivos Necessários:**
- `src/lib/boletos/boletoParser.ts` - Parser de códigos de barras
- `src/lib/boletos/ocrService.ts` - Serviço de OCR
- `src/lib/boletos/validator.ts` - Validador de boletos
- `src/components/boletos/BoletoCapture.tsx` - Interface de captura
- `src/components/boletos/BoletoPreview.tsx` - Preview do boleto

**Schema do Supabase:**
```sql
-- Tabela para boletos capturados
CREATE TABLE captured_boletos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  
  -- Dados do boleto
  barcode TEXT NOT NULL,
  linha_digitavel TEXT,
  beneficiario TEXT NOT NULL,
  pagador TEXT,
  valor DECIMAL(10,2) NOT NULL,
  data_vencimento DATE NOT NULL,
  data_documento DATE,
  numero_documento TEXT,
  
  -- Categorização
  categoria_sugerida TEXT,
  categoria_confianca DECIMAL(3,2),
  conta_recorrente_id UUID,
  
  -- Metadados de captura
  fonte TEXT CHECK (fonte IN ('camera', 'upload', 'pdf')),
  arquivo_original TEXT, -- Path no Supabase Storage
  ocr_confianca DECIMAL(3,2),
  tempo_processamento_ms INTEGER,
  
  -- Status e agendamento
  status TEXT DEFAULT 'captured' CHECK (status IN ('captured', 'validated', 'scheduled', 'paid', 'error')),
  agendado_para TIMESTAMP WITH TIME ZONE,
  pago_em TIMESTAMP WITH TIME ZONE,
  
  -- Flags de qualidade
  is_suspeito BOOLEAN DEFAULT false,
  motivo_suspeita TEXT,
  validado_manualmente BOOLEAN DEFAULT false,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para beneficiários conhecidos
CREATE TABLE beneficiarios_conhecidos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome_normalizado TEXT NOT NULL UNIQUE,
  nomes_alternativos TEXT[],
  categoria_padrao TEXT,
  is_confiavel BOOLEAN DEFAULT true,
  is_recorrente BOOLEAN DEFAULT false,
  valor_medio DECIMAL(10,2),
  frequencia_dias INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### Algoritmos de Processamento

**Parser de Código de Barras FEBRABAN:**
```typescript
interface BoletoData {
  codigoBanco: string;
  moeda: string;
  digitoVerificador: string;
  dataVencimento: Date;
  valor: number;
  campoLivre: string;
}

function parseBoletoBarcode(barcode: string): BoletoData {
  // Implementação do padrão FEBRABAN
  // Posições específicas para cada campo
  // Validação de dígito verificador
}
```

**Validação de Boletos:**
- Dígito verificador por módulo 10 e 11
- Validação de data (não pode ser muito antiga)
- Validação de valor (range razoável)
- Verificação de formato do código

### Testing

**Localização:** `src/test/boletos/`
**Frameworks:** Vitest + imagens de teste sintéticas
**Cenários de Teste:**
- Leitura de boletos de diferentes bancos
- Validação de códigos corretos e incorretos
- Processamento de imagens com qualidade variada
- Detecção de boletos suspeitos
- Performance com múltiplos boletos

**Datasets de Teste:**
- Boletos sintéticos de principais bancos
- Imagens com diferentes qualidades
- Códigos de barras válidos e inválidos
- PDFs com múltiplas páginas

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*