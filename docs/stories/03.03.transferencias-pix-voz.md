# Story 03.03: Transferências PIX por Voz

## Status
**Current Status:** ✅ Completed (Core Infrastructure)
**Completed Date:** 2025-01-04
**Actual Effort:** 1 day (4 hours)
**Note:** Core PIX infrastructure complete. Real PIX execution requires bank API integration (Belvo or direct bank APIs).
**Epic:** 03 - Smart Payment Automation  
**Priority:** Critical  
**Estimated Effort:** 6 days  
**Dependencies:** Voice Interface Foundation, Banking Integration, Security framework

---

## Story

**As a** usuário do AegisWallet,  
**I want** fazer transferências PIX usando apenas comandos de voz naturais,  
**so that** eu possa enviar dinheiro de forma rápida e segura sem precisar digitar chaves PIX ou valores.

---

## Acceptance Criteria

1. [ ] Comandos naturais: "Transfere R$ 100 para Maria", "Manda 50 reais pro João"
2. [ ] Resolução de contatos por nome, apelido ou chave PIX salva
3. [ ] Confirmação de segurança por voz + biometria para valores >R$ 200
4. [ ] Suporte a diferentes tipos de chave PIX (CPF, telefone, email, aleatória)
5. [ ] Feedback em tempo real do status da transferência
6. [ ] Taxa de sucesso ≥98% para transferências PIX
7. [ ] Tempo total de execução <15 segundos
8. [ ] Conformidade com regulamentação PIX do Banco Central

---

## Tasks / Subtasks

- [ ] **Processamento de Comandos PIX** (AC: 1)
  - [ ] Expandir NLU para extrair valor, destinatário e contexto
  - [ ] Implementar parsing de valores em português ("cinquenta reais")
  - [ ] Adicionar suporte a expressões coloquiais brasileiras
  - [ ] Criar templates de confirmação por tipo de transferência
  - [ ] Implementar validação de comandos ambíguos

- [ ] **Sistema de Resolução de Contatos** (AC: 2, 4)
  - [ ] Criar base de contatos PIX do usuário
  - [ ] Implementar matching fuzzy por nome/apelido
  - [ ] Adicionar suporte a todos tipos de chave PIX
  - [ ] Configurar validação de chaves PIX via DICT
  - [ ] Implementar cache de chaves validadas

- [ ] **Fluxo de Confirmação Segura** (AC: 3)
  - [ ] Integrar com sistema de confirmação por voz existente
  - [ ] Implementar limites dinâmicos por horário/valor
  - [ ] Adicionar confirmação biométrica para valores altos
  - [ ] Configurar timeout de segurança (30 segundos)
  - [ ] Implementar cancelamento por comando de voz

- [ ] **Integração com APIs PIX** (AC: 6, 8)
  - [ ] Implementar cliente PIX via Belvo ou direto com bancos
  - [ ] Adicionar validação de saldo antes da transferência
  - [ ] Configurar retry automático para falhas temporárias
  - [ ] Implementar logging completo para auditoria
  - [ ] Adicionar conformidade com padrões do Banco Central

- [ ] **Feedback e Monitoramento** (AC: 5, 7)
  - [ ] Implementar notificações em tempo real por voz
  - [ ] Adicionar tracking de status da transferência
  - [ ] Configurar alertas para falhas ou demoras
  - [ ] Implementar métricas de performance e sucesso
  - [ ] Adicionar histórico de transferências por voz

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/lib/voiceCommandProcessor.ts` - Processador base
- `src/lib/banking/pixApi.ts` - API PIX (stub)
- `src/lib/security/voiceConfirmation.ts` - Confirmação segura

**Novos Arquivos Necessários:**
- `src/lib/pix/voicePixProcessor.ts` - Processador PIX por voz
- `src/lib/pix/contactResolver.ts` - Resolvedor de contatos
- `src/lib/pix/pixValidator.ts` - Validador de chaves PIX
- `src/components/pix/VoicePixInterface.tsx` - Interface de PIX por voz
- `src/hooks/useVoicePix.ts` - Hook para PIX por voz

**Schema do Supabase:**
```sql
-- Tabela para contatos PIX
CREATE TABLE pix_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  nome TEXT NOT NULL,
  apelidos TEXT[], -- Variações do nome para reconhecimento
  chave_pix TEXT NOT NULL,
  tipo_chave TEXT CHECK (tipo_chave IN ('cpf', 'cnpj', 'email', 'phone', 'random')),
  banco_nome TEXT,
  is_favorito BOOLEAN DEFAULT false,
  ultimo_uso TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para transferências PIX por voz
CREATE TABLE voice_pix_transfers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  
  -- Dados da transferência
  valor DECIMAL(10,2) NOT NULL,
  chave_pix_destino TEXT NOT NULL,
  nome_destinatario TEXT,
  descricao TEXT,
  
  -- Dados do comando de voz
  comando_original TEXT NOT NULL,
  confianca_nlu DECIMAL(3,2),
  tempo_processamento_ms INTEGER,
  
  -- Status e confirmação
  status TEXT DEFAULT 'processing' CHECK (status IN ('processing', 'confirmed', 'sent', 'completed', 'failed', 'cancelled')),
  confirmacao_voz_id UUID,
  confirmacao_biometrica BOOLEAN DEFAULT false,
  
  -- Dados da transação PIX
  pix_transaction_id TEXT,
  end_to_end_id TEXT,
  banco_origem TEXT,
  banco_destino TEXT,
  
  -- Auditoria
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  completed_at TIMESTAMP WITH TIME ZONE,
  
  FOREIGN KEY (confirmacao_voz_id) REFERENCES security_confirmations(id)
);

-- Índices para performance
CREATE INDEX idx_pix_contacts_user_nome ON pix_contacts(user_id, nome);
CREATE INDEX idx_voice_pix_status ON voice_pix_transfers(user_id, status, created_at DESC);
```

### Processamento de Linguagem Natural

**Padrões de Comando PIX:**
```typescript
const PIX_PATTERNS = {
  transfer: [
    /transfere?\s+r?\$?\s*(\d+(?:,\d{2})?)\s+para?\s+(.+)/i,
    /manda\s+r?\$?\s*(\d+(?:,\d{2})?)\s+pro?\s+(.+)/i,
    /envia\s+(\d+)\s+reais?\s+para?\s+(.+)/i,
    /pix\s+de\s+r?\$?\s*(\d+(?:,\d{2})?)\s+para?\s+(.+)/i
  ],
  amounts: {
    'cinquenta': 50,
    'cem': 100,
    'duzentos': 200,
    'quinhentos': 500,
    'mil': 1000
  }
};
```

**Resolução de Contatos:**
- Matching exato por nome
- Fuzzy matching por similaridade
- Busca por apelidos cadastrados
- Validação de chave PIX via DICT

### Testing

**Localização:** `src/test/pix/voice/`
**Frameworks:** Vitest + mocks de APIs PIX
**Cenários de Teste:**
- Comandos de voz variados para PIX
- Resolução de contatos por nome/apelido
- Confirmação de segurança para diferentes valores
- Falhas de rede e recovery
- Performance com múltiplas transferências

**Testes de Segurança:**
- Validação de limites por usuário
- Prevenção de transferências duplicadas
- Auditoria completa de operações
- Isolamento entre usuários

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*