# Story 03.04: Transparência e Controles de Autonomia

## Status
**Current Status:** Draft  
**Epic:** 03 - Smart Payment Automation  
**Priority:** High  
**Estimated Effort:** 4 days  
**Dependencies:** Frontend Voz-First, Supabase analytics, AI explainability

---

## Story

**As a** usuário do AegisWallet,  
**I want** um painel completo que mostra todos os pagamentos executados automaticamente, suas justificativas e me permite controlar a autonomia,  
**so that** eu tenha transparência total sobre as ações da IA e possa ajustar o nível de automação conforme minha confiança.

---

## Acceptance Criteria

1. [ ] Dashboard com pagamentos executados, agendados e bloqueados
2. [ ] Explicabilidade da IA: motivos e regras que dispararam a automação
3. [ ] Botão "Pause" e "Cancelar" para cada pagamento com auditoria
4. [ ] Configuração granular de limites por tipo de pagamento
5. [ ] Exportação de relatórios mensais para o usuário
6. [ ] Tempo de carregamento do dashboard <3 segundos
7. [ ] Atualização em tempo real de status de pagamentos
8. [ ] Interface acessível WCAG 2.1 AA+ para controles críticos

---

## Tasks / Subtasks

- [ ] **Dashboard de Transparência** (AC: 1, 6, 7)
  - [ ] Criar interface principal com três seções (executados, agendados, bloqueados)
  - [ ] Implementar timeline de pagamentos com status visual
  - [ ] Adicionar filtros por data, valor, categoria e status
  - [ ] Configurar atualização em tempo real via Supabase subscriptions
  - [ ] Otimizar performance para carregamento <3s

- [ ] **Sistema de Explicabilidade** (AC: 2)
  - [ ] Implementar painel "Por que foi executado?" para cada pagamento
  - [ ] Criar visualização de regras aplicadas (valor, recorrência, confiança)
  - [ ] Adicionar contexto de dados utilizados (saldo, histórico, padrões)
  - [ ] Implementar linguagem natural para explicações
  - [ ] Configurar diferentes níveis de detalhamento

- [ ] **Controles de Intervenção** (AC: 3)
  - [ ] Implementar botão "Pausar Automação" por categoria
  - [ ] Adicionar "Cancelar Pagamento" para itens agendados
  - [ ] Criar "Reverter Decisão" para pagamentos executados
  - [ ] Implementar confirmação dupla para ações críticas
  - [ ] Configurar logs de auditoria para todas as intervenções

- [ ] **Configuração Granular de Limites** (AC: 4)
  - [ ] Criar interface para limites por categoria (contas, transferências, etc.)
  - [ ] Implementar sliders de autonomia (0-100%) por tipo
  - [ ] Adicionar configuração de horários permitidos
  - [ ] Configurar limites de valor por período (diário, mensal)
  - [ ] Implementar templates de configuração (conservador, moderado, agressivo)

- [ ] **Relatórios e Exportação** (AC: 5, 8)
  - [ ] Implementar geração de relatórios mensais automatizados
  - [ ] Criar exportação em PDF e CSV
  - [ ] Adicionar métricas de economia de tempo e redução de atrasos
  - [ ] Configurar envio automático por email
  - [ ] Implementar acessibilidade completa para relatórios

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/components/voice/VoiceDashboard.tsx` - Dashboard principal
- `src/server/procedures/payments.ts` - APIs de pagamentos
- `src/hooks/` - Hooks React para estado

**Novos Arquivos Necessários:**
- `src/components/autonomy/TransparencyDashboard.tsx` - Dashboard principal
- `src/components/autonomy/ExplainabilityPanel.tsx` - Painel de explicações
- `src/components/autonomy/AutonomyControls.tsx` - Controles de autonomia
- `src/components/autonomy/PaymentTimeline.tsx` - Timeline de pagamentos
- `src/hooks/useAutonomySettings.ts` - Hook para configurações

**Schema do Supabase:**
```sql
-- Tabela para configurações de autonomia
CREATE TABLE autonomy_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  
  -- Configurações por categoria
  bills_autonomy_level INTEGER DEFAULT 50 CHECK (bills_autonomy_level >= 0 AND bills_autonomy_level <= 100),
  transfers_autonomy_level INTEGER DEFAULT 30 CHECK (transfers_autonomy_level >= 0 AND transfers_autonomy_level <= 100),
  investments_autonomy_level INTEGER DEFAULT 0 CHECK (investments_autonomy_level >= 0 AND investments_autonomy_level <= 100),
  
  -- Limites financeiros
  daily_limit DECIMAL(10,2) DEFAULT 1000.00,
  monthly_limit DECIMAL(10,2) DEFAULT 10000.00,
  single_transaction_limit DECIMAL(10,2) DEFAULT 500.00,
  
  -- Configurações de horário
  allowed_hours_start TIME DEFAULT '08:00:00',
  allowed_hours_end TIME DEFAULT '18:00:00',
  weekend_enabled BOOLEAN DEFAULT false,
  
  -- Configurações de notificação
  notify_before_execution BOOLEAN DEFAULT true,
  notify_after_execution BOOLEAN DEFAULT true,
  notification_advance_hours INTEGER DEFAULT 2,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para explicações de decisões
CREATE TABLE payment_explanations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  payment_id UUID REFERENCES scheduled_payments(id),
  
  -- Dados da decisão
  decision_type TEXT NOT NULL CHECK (decision_type IN ('execute', 'schedule', 'block', 'request_approval')),
  confidence_score DECIMAL(3,2) NOT NULL,
  
  -- Fatores da decisão
  factors_used JSONB NOT NULL, -- {balance: 5000, history: "regular", pattern: "monthly"}
  rules_applied TEXT[] NOT NULL, -- ["sufficient_balance", "recurring_pattern", "within_limits"]
  risk_assessment TEXT,
  
  -- Explicação em linguagem natural
  explanation_text TEXT NOT NULL,
  technical_details JSONB,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para intervenções do usuário
CREATE TABLE user_interventions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  payment_id UUID REFERENCES scheduled_payments(id),
  
  -- Tipo de intervenção
  intervention_type TEXT NOT NULL CHECK (intervention_type IN ('pause', 'cancel', 'revert', 'approve', 'modify')),
  reason TEXT,
  
  -- Estado anterior e novo
  previous_status TEXT,
  new_status TEXT,
  
  -- Metadados
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para relatórios mensais
CREATE TABLE monthly_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  report_month DATE NOT NULL, -- Primeiro dia do mês
  
  -- Métricas do período
  total_payments INTEGER DEFAULT 0,
  automated_payments INTEGER DEFAULT 0,
  manual_payments INTEGER DEFAULT 0,
  cancelled_payments INTEGER DEFAULT 0,
  
  -- Valores financeiros
  total_amount DECIMAL(12,2) DEFAULT 0,
  automated_amount DECIMAL(12,2) DEFAULT 0,
  fees_saved DECIMAL(10,2) DEFAULT 0,
  
  -- Métricas de tempo
  time_saved_minutes INTEGER DEFAULT 0,
  average_processing_time_ms INTEGER,
  
  -- Dados de confiança
  autonomy_level_avg DECIMAL(3,2),
  user_interventions INTEGER DEFAULT 0,
  
  -- Arquivo do relatório
  report_file_path TEXT,
  generated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(user_id, report_month)
);
```

### Interface de Transparência

**Seções do Dashboard:**
1. **Resumo Executivo**: Autonomia atual, economia de tempo, próximas ações
2. **Timeline de Pagamentos**: Histórico visual com status e explicações
3. **Controles de Autonomia**: Sliders e configurações por categoria
4. **Explicações Detalhadas**: "Por que" para cada decisão automática
5. **Relatórios**: Métricas mensais e exportação

**Linguagem Natural para Explicações:**
```typescript
const explanationTemplates = {
  execute: "Executei este pagamento porque: {reasons}. Baseei-me em: {data_sources}.",
  schedule: "Agendei para {date} porque: {reasons}. Você pode cancelar até {deadline}.",
  block: "Bloqueei este pagamento porque: {reasons}. Preciso de sua aprovação.",
  request_approval: "Solicito aprovação porque: {reasons}. Valor acima do limite configurado."
};
```

### Testing

**Localização:** `src/test/autonomy/transparency/`
**Frameworks:** Vitest + Testing Library + Playwright
**Cenários de Teste:**
- Renderização correta de diferentes tipos de pagamento
- Funcionalidade de controles de intervenção
- Geração e exportação de relatórios
- Acessibilidade com screen readers
- Performance com grandes volumes de dados

**Testes de Usabilidade:**
- Clareza das explicações para usuários leigos
- Facilidade de uso dos controles de autonomia
- Compreensão das métricas apresentadas
- Eficácia dos relatórios mensais

**Métricas de Qualidade:**
- Tempo de carregamento <3s
- Taxa de compreensão das explicações >90%
- Satisfação com transparência >4.5/5
- Uso dos controles de autonomia >60%

### Configurações de Autonomia

**Níveis Pré-definidos:**
- **Conservador (30%)**: Apenas contas recorrentes <R$ 200
- **Moderado (60%)**: Contas e transferências <R$ 1.000
- **Agressivo (90%)**: Quase tudo automático <R$ 5.000

**Regras de Segurança:**
- Nunca executar sem saldo suficiente
- Sempre notificar antes de valores altos
- Pausar automação se muitas intervenções
- Requerer reconfirmação após 30 dias

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*