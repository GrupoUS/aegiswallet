# System Patterns

- **Architecture**: Simplified monólito (frontend+backend) com tRPC no Hono e Supabase como data layer + realtime. Voz é interface primária e tudo segue KISS/YAGNI.
- **Directory Highlights**: `src/components` (UI modular), `src/routes` (TanStack Router), `src/hooks` (data/voice hooks), `src/lib` (banking, voice, PIX, formatters), `src/server/routers` (tRPC routers), `supabase/migrations` (schema/RLS source).
- **Key Modules**:
  - `voiceCommandProcessor` orquestra reconhecimento → intenção → ação → resposta.
  - `bankAccounts` router expõe CRUD e usa Supabase realtime para sincronizar UI.
  - `transactions` router agrega projeções e métricas (dashboard/resumo mensal).
  - `pix` router manipula transferências e confirmações seguras.
- **Patterns**:
  - Zod schemas compartilhados entre frontend/backend para validação.
  - Supabase client wrappers em `src/integrations/supabase` (client/auth/realtime) centralizam configuração.
  - Hooks (`useBankAccounts`, `useDashboard`) consomem tRPC + invalidam cache após mutações.
  - Logging padronizado via `lib/logger` (JSON structured) + scripts `scripts/validate-logging.js`.
- **Data Flow**: Form → React Hook Form/Zod → tRPC mutation → Supabase insert/update → realtime channel → hooks atualizam UI.
- **Implementation Snapshot**:
  - Frontend usa React 19 + TanStack Query/Router, Tailwind/shadcn para UI e PWA mobile-first.
  - Backend roda em Bun + Hono + tRPC (edge-friendly) com Supabase PostgreSQL/SR e realtime channels (`bank_accounts`, `transactions`, `pix_transactions`).
  - Voice stack cobre reconhecimento (Web Speech API), intent classification (`voiceCommandProcessor`) e síntese com feedback visual (ver Epic 4).
  - Automação de pagamentos depende do pipeline Smart Payment (OCR + scheduling) ainda em desenvolvimento; hooks atuais focam em calendário financeiro e PIX.
- **Voice-First Stack**: Web Speech API + serviços próprios em `lib/speech` garantem reconhecimento PT-BR com fallback textual; confirmações seguras usam `VoiceConfirmationService`.
- **Calendar & Financial Events**: `useFinancialEvents` mantém mapa full-fidelity (start/end, status, tags, metadata) alimentando o calendário semanal; dados residem em `financial_events` com RLS por `auth.uid()`.
- **Automation Engines**: `Smart Payment Automation` depende de `transactions`, `pix` e agendamentos; decisões autônomas sempre registradas com metadados (origem, confiança) para auditoria.
- **Testing/QA**: Vitest + Playwright; integrações críticas devem ter testes em `src/test/integration` usando Supabase real (service role). OXLint/Biome guardam estilo.
