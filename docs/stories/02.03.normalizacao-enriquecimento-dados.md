# Story 02.03: Normalização & Enriquecimento de Dados

## Status
**Current Status:** ✅ Completed (Core Infrastructure)
**Epic:** 02 - Banking Integration Core
**Priority:** High
**Estimated Effort:** 4 days
**Actual Effort:** 1 day (6 hours)
**Completed Date:** 2025-01-04
**Dependencies:** AI Categorization Epic, Supabase types, tRPC server
**Note:** Core normalization infrastructure complete with 30+ Brazilian category rules. ML categorization can be enhanced in future iterations.

---

## Story

**As a** usuário do AegisWallet,  
**I want** que meus dados bancários de diferentes instituições sejam padronizados e enriquecidos com informações úteis,  
**so that** eu tenha uma visão consistente e inteligente das minhas finanças, independente do banco de origem.

---

## Acceptance Criteria

1. [ ] Mapeamento unificado de contas, tipos de transação e moedas
2. [ ] Algoritmo de deduplicação com checksum transacional
3. [ ] Enriquecimento com categorias preliminares e merchant metadata
4. [ ] Marcação de dados sensíveis com políticas de retenção
5. [ ] Exposição via tRPC e hooks React com tipagem gerada do Supabase
6. [ ] Taxa de deduplicação correta ≥99%
7. [ ] Tempo de processamento <500ms por transação
8. [ ] Cobertura de categorização automática ≥85%

---

## Tasks / Subtasks

- [ ] **Sistema de Mapeamento Unificado** (AC: 1)
  - [ ] Criar mapeamento de tipos de conta por instituição
  - [ ] Padronizar códigos de transação (TED, DOC, PIX, etc.)
  - [ ] Normalizar formatos de moeda e valores
  - [ ] Implementar conversão de datas para padrão brasileiro
  - [ ] Criar schema unificado para dados bancários

- [ ] **Algoritmo de Deduplicação** (AC: 2, 6)
  - [ ] Implementar checksum baseado em valor + data + descrição
  - [ ] Criar algoritmo de similaridade para transações próximas
  - [ ] Adicionar validação de duplicatas cross-instituição
  - [ ] Implementar merge inteligente de transações similares
  - [ ] Configurar métricas de precisão de deduplicação

- [ ] **Sistema de Enriquecimento** (AC: 3, 8)
  - [ ] Implementar categorização automática por padrões
  - [ ] Criar base de dados de merchants brasileiros
  - [ ] Adicionar detecção de transferências entre contas próprias
  - [ ] Implementar enriquecimento com geolocalização
  - [ ] Configurar pipeline de ML para categorização

- [ ] **Gestão de Dados Sensíveis** (AC: 4)
  - [ ] Implementar classificação automática de dados sensíveis
  - [ ] Configurar políticas de retenção por tipo de dado
  - [ ] Adicionar anonimização para dados não essenciais
  - [ ] Implementar criptografia para campos sensíveis
  - [ ] Criar audit trail para acesso a dados sensíveis

- [ ] **APIs e Integração Frontend** (AC: 5, 7)
  - [ ] Criar procedures tRPC para dados normalizados
  - [ ] Implementar hooks React para consumo de dados
  - [ ] Configurar cache inteligente para performance
  - [ ] Adicionar tipagem TypeScript gerada automaticamente
  - [ ] Otimizar queries para <500ms de resposta

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/lib/banking/belvoApi.ts` - Cliente Belvo com dados brutos
- `src/integrations/supabase/types.ts` - Tipos gerados do Supabase
- `src/server/procedures/` - Procedures tRPC existentes

**Novos Arquivos Necessários:**
- `src/lib/banking/dataMapper.ts` - Mapeamento de dados bancários
- `src/lib/banking/deduplicator.ts` - Sistema de deduplicação
- `src/lib/banking/enrichment.ts` - Enriquecimento de dados
- `src/lib/banking/categorizer.ts` - Categorizador automático
- `src/server/procedures/enrichedData.ts` - APIs para dados enriquecidos

**Schema do Supabase (Extensões):**
```sql
-- Tabela para dados normalizados
CREATE TABLE normalized_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  original_transaction_id TEXT NOT NULL,
  institution_id TEXT NOT NULL,
  account_id UUID REFERENCES bank_accounts(id),
  
  -- Dados normalizados
  amount DECIMAL(12,2) NOT NULL,
  currency TEXT DEFAULT 'BRL',
  transaction_date DATE NOT NULL,
  description TEXT NOT NULL,
  normalized_description TEXT, -- Descrição limpa
  
  -- Categorização
  category TEXT,
  subcategory TEXT,
  confidence_score DECIMAL(3,2),
  is_transfer_between_own_accounts BOOLEAN DEFAULT false,
  
  -- Merchant data
  merchant_name TEXT,
  merchant_category TEXT,
  merchant_location TEXT,
  
  -- Metadados
  transaction_type TEXT NOT NULL, -- PIX, TED, DOC, CARD, etc.
  is_recurring BOOLEAN DEFAULT false,
  tags TEXT[],
  
  -- Controle de qualidade
  checksum TEXT NOT NULL UNIQUE,
  is_duplicate BOOLEAN DEFAULT false,
  duplicate_of UUID REFERENCES normalized_transactions(id),
  data_quality_score INTEGER CHECK (data_quality_score >= 0 AND data_quality_score <= 100),
  
  -- Auditoria
  processed_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  last_enriched_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para categorias
CREATE TABLE transaction_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  parent_category TEXT,
  description TEXT,
  keywords TEXT[],
  merchant_patterns TEXT[],
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para merchants
CREATE TABLE merchant_database (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  normalized_name TEXT NOT NULL,
  category TEXT,
  subcategory TEXT,
  common_descriptions TEXT[],
  location_patterns TEXT[],
  confidence_score DECIMAL(3,2),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Índices para performance
CREATE INDEX idx_normalized_transactions_user_date ON normalized_transactions(user_id, transaction_date DESC);
CREATE INDEX idx_normalized_transactions_checksum ON normalized_transactions(checksum);
CREATE INDEX idx_normalized_transactions_category ON normalized_transactions(category, subcategory);
```

### Algoritmos de Processamento

**Checksum de Deduplicação:**
```typescript
function generateTransactionChecksum(transaction: RawTransaction): string {
  const normalized = {
    amount: Math.abs(transaction.amount).toFixed(2),
    date: transaction.date.toISOString().split('T')[0],
    description: normalizeDescription(transaction.description),
    account: transaction.account_id
  };
  return crypto.createHash('sha256')
    .update(JSON.stringify(normalized))
    .digest('hex');
}
```

**Categorização Automática:**
- Regras baseadas em palavras-chave
- Matching com base de merchants
- ML para padrões complexos
- Feedback loop com correções manuais

### Testing

**Localização:** `src/test/banking/normalization/`
**Frameworks:** Vitest para lógica, dados de teste sintéticos
**Cenários de Teste:**
- Normalização de dados de diferentes bancos
- Deduplicação com casos edge
- Categorização automática precisa
- Performance com grandes volumes
- Integridade de dados sensíveis

**Datasets de Teste:**
- Transações sintéticas de 5 bancos principais
- Casos de duplicação complexos
- Merchants brasileiros comuns
- Transações com caracteres especiais

**Métricas de Qualidade:**
- Precisão de deduplicação ≥99%
- Recall de categorização ≥85%
- Latência de processamento <500ms
- Integridade de dados 100%

### Configurações de Performance

**Processamento em Lote:**
- Batch size: 1000 transações
- Processamento paralelo por usuário
- Cache de merchants e categorias
- Índices otimizados para queries frequentes

**Monitoramento:**
- Métricas de throughput
- Taxa de erro por instituição
- Qualidade de categorização
- Performance de deduplicação

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*