# Story 05.03: Painel de Explicabilidade e Transpar√™ncia

## Status
**Current Status:** Approved  
**Epic:** 05 - Autonomous Financial Intelligence  
**Priority:** Future  
**Estimated Effort:** 4 days  
**Dependencies:** Frontend Voz-First, Design system, Data visualization

---

## Story

**As a** usu√°rio do AegisWallet,  
**I want** um painel completo que explique todas as decis√µes da IA de forma clara e transparente,  
**so that** eu possa entender, confiar e ajustar o comportamento aut√¥nomo do sistema.

---

## Acceptance Criteria

1. [ ] Visualiza√ß√£o de cada decis√£o com "por que fizemos" e "o que voc√™ pode fazer"
2. [ ] Hist√≥ricos filtr√°veis por categoria, data, impacto financeiro
3. [ ] Destaque de oportunidades futuras sugeridas
4. [ ] Op√ß√£o de reverter decis√£o e enviar feedback √† IA
5. [ ] Conformidade com diretrizes de UX √©tica
6. [ ] Interface responsiva e acess√≠vel WCAG 2.1 AA+
7. [ ] Tempo de carregamento <2 segundos
8. [ ] Linguagem natural clara para usu√°rios leigos

---

## Tasks / Subtasks

- [ ] **Interface Principal de Explicabilidade** (AC: 1, 8)
  - [ ] Criar ExplainabilityDashboard com decis√µes recentes
  - [ ] Implementar cards expand√≠veis para cada decis√£o
  - [ ] Adicionar se√ß√£o "Por que a IA fez isso?"
  - [ ] Configurar linguagem natural brasileira
  - [ ] Implementar diferentes n√≠veis de detalhamento

- [ ] **Sistema de Filtros e Hist√≥rico** (AC: 2, 7)
  - [ ] Implementar filtros por categoria, data, valor
  - [ ] Adicionar busca por descri√ß√£o ou benefici√°rio
  - [ ] Configurar pagina√ß√£o otimizada
  - [ ] Implementar cache inteligente
  - [ ] Otimizar performance para <2s

- [ ] **Recomenda√ß√µes e Oportunidades** (AC: 3)
  - [ ] Criar se√ß√£o de oportunidades futuras
  - [ ] Implementar cards de sugest√µes proativas
  - [ ] Adicionar estimativas de impacto financeiro
  - [ ] Configurar prioriza√ß√£o por relev√¢ncia
  - [ ] Implementar a√ß√µes r√°pidas para aceitar/rejeitar

- [ ] **Sistema de Feedback e Revers√£o** (AC: 4, 5)
  - [ ] Implementar bot√µes de feedback (üëçüëé)
  - [ ] Adicionar op√ß√£o "Reverter esta decis√£o"
  - [ ] Configurar confirma√ß√£o dupla para revers√µes
  - [ ] Implementar coleta de feedback textual
  - [ ] Adicionar auditoria de todas as intera√ß√µes

---

## Dev Notes

### Arquitetura Completa

**Componentes Principais:**
- `src/components/ai/ExplainabilityDashboard.tsx` - Dashboard principal
- `src/components/ai/DecisionCard.tsx` - Card individual de decis√£o
- `src/components/ai/OpportunityPanel.tsx` - Painel de oportunidades
- `src/components/ai/FeedbackSystem.tsx` - Sistema de feedback
- `src/components/ai/DecisionTimeline.tsx` - Timeline de decis√µes
- `src/components/ai/ExplanationModal.tsx` - Modal de explica√ß√£o detalhada

**Hooks Necess√°rios:**
- `src/hooks/useDecisionHistory.ts` - Hist√≥rico de decis√µes
- `src/hooks/useExplanations.ts` - Explica√ß√µes detalhadas
- `src/hooks/useDecisionFeedback.ts` - Sistema de feedback
- `src/hooks/useOpportunities.ts` - Oportunidades futuras

### Sistema de Explica√ß√µes Detalhado

**Templates de Linguagem Natural:**
```typescript
// src/lib/ai/explanationTemplates.ts
interface ExplanationTemplate {
  type: DecisionType;
  template: string;
  variables: string[];
  examples: string[];
}

const explanationTemplates: ExplanationTemplate[] = [
  {
    type: 'payment',
    template: "Paguei sua conta de {service} no valor de {amount} porque {reasons}.",
    variables: ['service', 'amount', 'reasons'],
    examples: [
      "Paguei sua conta de energia no valor de R$ 150,00 porque voc√™ sempre paga no dia 4 e tem saldo suficiente.",
      "Paguei sua conta de internet no valor de R$ 89,90 porque √© um pagamento recorrente e est√° dentro do or√ßamento."
    ]
  },
  {
    type: 'alert',
    template: "Alertei sobre {topic} porque {opportunity} baseado no seu padr√£o de {period}.",
    variables: ['topic', 'opportunity', 'period'],
    examples: [
      "Alertei sobre mudan√ßa de plano porque pode economizar R$ 45,00 baseado no seu padr√£o dos √∫ltimos 3 meses.",
      "Alertei sobre investimento porque voc√™ tem R$ 500,00 parados h√° mais de 30 dias."
    ]
  },
  {
    type: 'block',
    template: "Bloqueei {action} porque {reason} e preciso de sua confirma√ß√£o.",
    variables: ['action', 'reason'],
    examples: [
      "Bloqueei a transfer√™ncia de R$ 2.000,00 porque excede seu limite di√°rio de R$ 1.500,00.",
      "Bloqueei o pagamento porque n√£o reconhe√ßo este benefici√°rio em seu hist√≥rico."
    ]
  }
];

class ExplanationGenerator {
  generateExplanation(decision: AIDecision): DetailedExplanation {
    const template = this.getTemplate(decision.type);
    const variables = this.extractVariables(decision);
    const explanation = this.fillTemplate(template, variables);

    return {
      summary: explanation,
      reasoning: this.generateReasoning(decision),
      dataUsed: this.getDataSources(decision),
      confidence: decision.confidence,
      alternatives: this.generateAlternatives(decision),
      userActions: this.getAvailableActions(decision)
    };
  }

  private generateReasoning(decision: AIDecision): string[] {
    const reasons = [];

    if (decision.type === 'payment') {
      if (decision.isRecurring) {
        reasons.push(`√â um pagamento recorrente que voc√™ faz h√° ${decision.recurringMonths} meses`);
      }
      if (decision.balanceCheck) {
        reasons.push(`Seu saldo atual (${formatCurrency(decision.balance)}) √© suficiente`);
      }
      if (decision.withinBudget) {
        reasons.push(`Est√° dentro do or√ßamento de ${decision.category} (${decision.budgetUsage}% usado)`);
      }
    }

    return reasons;
  }
}
```

**Componente Principal:**
```typescript
// src/components/ai/ExplainabilityDashboard.tsx
interface ExplainabilityDashboardProps {
  userId: string;
  timeRange?: 'day' | 'week' | 'month';
  category?: DecisionCategory;
}

export function ExplainabilityDashboard({ userId, timeRange = 'week', category }: ExplainabilityDashboardProps) {
  const { data: decisions, isLoading } = useDecisionHistory({ userId, timeRange, category });
  const { data: opportunities } = useOpportunities({ userId });
  const [selectedDecision, setSelectedDecision] = useState<string | null>(null);

  return (
    <div className="space-y-6">
      {/* Header com filtros */}
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">Transpar√™ncia da IA</h2>
        <div className="flex gap-2">
          <TimeRangeSelector value={timeRange} onChange={setTimeRange} />
          <CategoryFilter value={category} onChange={setCategory} />
        </div>
      </div>

      {/* M√©tricas resumo */}
      <div className="grid grid-cols-4 gap-4">
        <MetricCard
          title="Decis√µes Tomadas"
          value={decisions?.length || 0}
          trend="+12% vs semana anterior"
        />
        <MetricCard
          title="Taxa de Acerto"
          value="94.2%"
          trend="+2.1% vs semana anterior"
        />
        <MetricCard
          title="Tempo Poupado"
          value="2h 15min"
          trend="+45min vs semana anterior"
        />
        <MetricCard
          title="Economia Gerada"
          value="R$ 127,50"
          trend="+R$ 23,00 vs semana anterior"
        />
      </div>

      {/* Timeline de decis√µes */}
      <DecisionTimeline
        decisions={decisions}
        onDecisionClick={setSelectedDecision}
      />

      {/* Painel de oportunidades */}
      <OpportunityPanel opportunities={opportunities} />

      {/* Modal de explica√ß√£o detalhada */}
      {selectedDecision && (
        <ExplanationModal
          decisionId={selectedDecision}
          onClose={() => setSelectedDecision(null)}
        />
      )}
    </div>
  );
}
```

### Sistema de Feedback

**Componente de Feedback:**
```typescript
// src/components/ai/FeedbackSystem.tsx
interface FeedbackSystemProps {
  decisionId: string;
  onFeedbackSubmitted: (feedback: DecisionFeedback) => void;
}

export function FeedbackSystem({ decisionId, onFeedbackSubmitted }: FeedbackSystemProps) {
  const [rating, setRating] = useState<1 | 2 | 3 | 4 | 5 | null>(null);
  const [comment, setComment] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const submitFeedback = async () => {
    if (!rating) return;

    setIsSubmitting(true);
    try {
      const feedback = await submitDecisionFeedback({
        decisionId,
        rating,
        comment: comment.trim() || undefined,
        timestamp: new Date().toISOString()
      });

      onFeedbackSubmitted(feedback);
      toast.success('Feedback enviado! Isso nos ajuda a melhorar.');
    } catch (error) {
      toast.error('Erro ao enviar feedback. Tente novamente.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="border rounded-lg p-4 space-y-4">
      <h4 className="font-medium">Esta explica√ß√£o foi √∫til?</h4>

      {/* Rating com emojis */}
      <div className="flex gap-2">
        {[1, 2, 3, 4, 5].map((value) => (
          <button
            key={value}
            onClick={() => setRating(value as any)}
            className={`text-2xl transition-transform hover:scale-110 ${
              rating === value ? 'scale-110' : 'opacity-60'
            }`}
          >
            {value <= 2 ? 'üòû' : value === 3 ? 'üòê' : 'üòä'}
          </button>
        ))}
      </div>

      {/* Coment√°rio opcional */}
      <textarea
        placeholder="Coment√°rio opcional..."
        value={comment}
        onChange={(e) => setComment(e.target.value)}
        className="w-full p-2 border rounded resize-none"
        rows={2}
      />

      {/* A√ß√µes */}
      <div className="flex gap-2">
        <Button
          onClick={submitFeedback}
          disabled={!rating || isSubmitting}
          size="sm"
        >
          {isSubmitting ? 'Enviando...' : 'Enviar Feedback'}
        </Button>
        <Button variant="outline" size="sm">
          Reverter Decis√£o
        </Button>
      </div>
    </div>
  );
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Cria√ß√£o inicial da story | PM Agent "John" |