# Story 02.01: Configuração de Conectores Open Banking

## Status
**Current Status:** Draft  
**Epic:** 02 - Banking Integration Core  
**Priority:** Critical  
**Estimated Effort:** 4 days  
**Dependencies:** Integração Belvo, Supabase Functions, Auth Context

---

## Story

**As a** usuário do AegisWallet,  
**I want** conectar minhas contas dos principais bancos brasileiros de forma segura e auditável,  
**so that** eu possa ter uma visão consolidada das minhas finanças e permitir automação inteligente dos meus pagamentos.

---

## Acceptance Criteria

1. [ ] Conectar Bradesco, Itaú, Banco do Brasil, Caixa e Nubank com status monitorável
2. [ ] Persistir tokens criptografados utilizando Supabase secrets
3. [ ] Implementar renovação automática de consentimento com notificações ao usuário
4. [ ] Registrar trilha de auditoria (quem conectou, quando, escopo de dados)
5. [ ] Testes automatizados cobrindo falhas de autenticação e consentimento negado
6. [ ] Taxa de sucesso de conexão ≥95% por instituição
7. [ ] Tempo de estabelecimento de conexão <30 segundos
8. [ ] Conformidade total com regulamentação Open Banking Brasil

---

## Tasks / Subtasks

- [ ] **Configuração da Integração Belvo** (AC: 1)
  - [ ] Configurar credenciais Belvo no ambiente de desenvolvimento
  - [ ] Implementar cliente Belvo com as 5 instituições prioritárias
  - [ ] Criar mapeamento de instituições para códigos Belvo
  - [ ] Implementar health check para status de cada conector
  - [ ] Adicionar retry logic para falhas temporárias de conexão

- [ ] **Sistema de Gerenciamento de Tokens** (AC: 2)
  - [ ] Implementar criptografia AES-256 para tokens de acesso
  - [ ] Configurar Supabase Vault para armazenamento seguro
  - [ ] Criar rotação automática de chaves de criptografia
  - [ ] Implementar isolamento de tokens por usuário (RLS)
  - [ ] Adicionar logs de acesso aos tokens para auditoria

- [ ] **Fluxo de Consentimento e Renovação** (AC: 3)
  - [ ] Implementar fluxo OAuth2 completo para cada banco
  - [ ] Criar sistema de notificação 7 dias antes do vencimento
  - [ ] Implementar renovação automática quando possível
  - [ ] Adicionar interface para re-autorização manual
  - [ ] Configurar webhooks para mudanças de status de consentimento

- [ ] **Sistema de Auditoria** (AC: 4)
  - [ ] Criar tabela de logs de conexão no Supabase
  - [ ] Implementar logging estruturado com metadados completos
  - [ ] Adicionar assinatura digital nos logs críticos
  - [ ] Criar dashboard interno para monitoramento de conexões
  - [ ] Implementar alertas para atividades suspeitas

- [ ] **Testes e Validação** (AC: 5, 6, 7, 8)
  - [ ] Criar suite de testes para cada instituição bancária
  - [ ] Implementar testes de falha e recuperação
  - [ ] Adicionar testes de performance e timeout
  - [ ] Validar conformidade com padrões Open Banking Brasil
  - [ ] Criar testes de carga para múltiplas conexões simultâneas

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/lib/banking/belvoApi.ts` - Cliente Belvo (stub implementado)
- `src/integrations/supabase/client.ts` - Cliente Supabase configurado
- `src/server/context.ts` - Contexto de autenticação tRPC

**Novos Arquivos Necessários:**
- `src/lib/banking/bankConnectors.ts` - Gerenciador de conectores
- `src/lib/banking/tokenManager.ts` - Gerenciamento seguro de tokens
- `src/lib/banking/auditLogger.ts` - Sistema de auditoria
- `src/server/procedures/banking.ts` - Procedures tRPC para banking

**Schema do Supabase:**
```sql
-- Tabela para conexões bancárias
CREATE TABLE bank_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  institution_id TEXT NOT NULL,
  institution_name TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('active', 'expired', 'revoked', 'error')),
  consent_expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para logs de auditoria
CREATE TABLE banking_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  action TEXT NOT NULL,
  institution_id TEXT,
  metadata JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### Configurações de Segurança

**Variáveis de Ambiente Necessárias:**
- `BELVO_API_KEY` - Chave da API Belvo
- `BELVO_SECRET_KEY` - Chave secreta Belvo
- `BANKING_ENCRYPTION_KEY` - Chave para criptografia de tokens
- `OPEN_BANKING_WEBHOOK_SECRET` - Secret para validação de webhooks

**Políticas RLS:**
- Usuários só podem ver suas próprias conexões bancárias
- Logs de auditoria isolados por usuário
- Tokens criptografados nunca expostos via API

### Testing

**Localização:** `src/test/banking/connectors/`
**Frameworks:** Vitest para lógica, Playwright para fluxos OAuth
**Ambientes de Teste:**
- Sandbox Belvo para testes automatizados
- Mock servers para testes de falha
- Ambiente de homologação com bancos reais

**Cenários de Teste Críticos:**
- Conexão bem-sucedida com cada banco
- Falha de autenticação e recuperação
- Expiração de token e renovação
- Revogação de consentimento pelo usuário
- Indisponibilidade temporária do banco

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*