# Story 05.01: Modelo de Pontuação de Confiança

## Status
**Current Status:** Draft  
**Epic:** 05 - Autonomous Financial Intelligence  
**Priority:** Future  
**Estimated Effort:** 5 days  
**Dependencies:** Banking data pipeline, User behavior analytics, ML infrastructure

---

## Story

**As a** usuário do AegisWallet,  
**I want** que o sistema aprenda meus padrões financeiros e construa confiança gradualmente,  
**so that** eu possa aumentar progressivamente o nível de autonomia do sistema conforme me sinto mais confortável.

---

## Acceptance Criteria

1. [ ] Algoritmo de scoring baseado em histórico, consistência e feedback
2. [ ] Níveis de confiança: Iniciante (50%), Intermediário (75%), Avançado (95%)
3. [ ] Dashboard para usuário visualizar e ajustar seu nível de confiança
4. [ ] Recomendações automáticas para aumentar autonomia baseadas em comportamento
5. [ ] Sistema de degradação de confiança em caso de erros ou mudanças de padrão
6. [ ] Precisão de predição de comportamento ≥85%
7. [ ] Tempo de cálculo de score <100ms
8. [ ] Transparência completa sobre fatores que influenciam o score

---

## Tasks / Subtasks

- [ ] **Algoritmo de Scoring de Confiança** (AC: 1, 6)
  - [ ] Definir fatores de confiança (histórico, consistência, feedback)
  - [ ] Implementar pesos dinâmicos por categoria de transação
  - [ ] Criar modelo de machine learning para predição
  - [ ] Adicionar normalização por perfil de usuário
  - [ ] Configurar validação cruzada do modelo

- [ ] **Sistema de Níveis de Autonomia** (AC: 2)
  - [ ] Implementar lógica de progressão 50% → 75% → 95%
  - [ ] Criar critérios específicos para cada nível
  - [ ] Adicionar limites de valor por nível de confiança
  - [ ] Configurar workflows de aprovação por nível
  - [ ] Implementar transições automáticas e manuais

- [ ] **Dashboard de Confiança** (AC: 3, 8)
  - [ ] Criar interface para visualização do score atual
  - [ ] Implementar gráficos de evolução temporal
  - [ ] Adicionar explicação dos fatores de influência
  - [ ] Configurar controles para ajuste manual
  - [ ] Implementar simulador de impacto de mudanças

- [ ] **Sistema de Recomendações** (AC: 4)
  - [ ] Implementar engine de recomendações personalizadas
  - [ ] Criar sugestões baseadas em padrões similares
  - [ ] Adicionar timing inteligente para sugestões
  - [ ] Configurar A/B testing para recomendações
  - [ ] Implementar feedback loop para melhoria

- [ ] **Sistema de Degradação e Recuperação** (AC: 5, 7)
  - [ ] Implementar detecção de mudanças de padrão
  - [ ] Configurar degradação automática por erros
  - [ ] Adicionar sistema de recuperação gradual
  - [ ] Implementar alertas para degradação significativa
  - [ ] Otimizar cálculos para <100ms de resposta

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/server/procedures/` - APIs tRPC existentes
- `supabase/` - Database com dados transacionais
- `src/hooks/` - Hooks React para estado

**Novos Arquivos Necessários:**
- `src/lib/ml/trustScoring.ts` - Algoritmo de scoring
- `src/lib/ml/behaviorAnalyzer.ts` - Análise comportamental
- `src/components/trust/TrustDashboard.tsx` - Dashboard de confiança
- `src/hooks/useTrustScore.ts` - Hook para score de confiança
- `src/server/procedures/trust.ts` - APIs de confiança

**Schema do Supabase:**
```sql
-- Tabela para scores de confiança
CREATE TABLE user_trust_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  
  -- Score atual
  current_score DECIMAL(5,2) NOT NULL CHECK (current_score >= 0 AND current_score <= 100),
  autonomy_level INTEGER NOT NULL CHECK (autonomy_level IN (50, 75, 95)),
  
  -- Fatores do score
  historical_consistency DECIMAL(5,2),
  transaction_patterns DECIMAL(5,2),
  feedback_quality DECIMAL(5,2),
  error_rate DECIMAL(5,2),
  usage_frequency DECIMAL(5,2),
  
  -- Metadados
  last_calculated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  calculation_version TEXT DEFAULT '1.0',
  
  -- Limites por nível
  daily_limit DECIMAL(10,2),
  transaction_limit DECIMAL(10,2),
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para histórico de scores
CREATE TABLE trust_score_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  score DECIMAL(5,2) NOT NULL,
  autonomy_level INTEGER NOT NULL,
  change_reason TEXT,
  factors JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para eventos que afetam confiança
CREATE TABLE trust_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  event_type TEXT NOT NULL CHECK (event_type IN ('positive', 'negative', 'neutral')),
  event_category TEXT NOT NULL,
  impact_score DECIMAL(3,2), -- -1.0 a +1.0
  description TEXT,
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para recomendações
CREATE TABLE trust_recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  recommendation_type TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  potential_impact DECIMAL(3,2),
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'rejected', 'expired')),
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### Algoritmo de Scoring

**Fatores de Confiança:**
```typescript
interface TrustFactors {
  historicalConsistency: number; // 0-100, baseado em padrões passados
  transactionPatterns: number;   // 0-100, regularidade de transações
  feedbackQuality: number;       // 0-100, qualidade do feedback dado
  errorRate: number;             // 0-100, inverso da taxa de erro
  usageFrequency: number;        // 0-100, frequência de uso do sistema
}

function calculateTrustScore(factors: TrustFactors): number {
  const weights = {
    historical: 0.3,
    patterns: 0.25,
    feedback: 0.2,
    errors: 0.15,
    usage: 0.1
  };
  
  return (
    factors.historicalConsistency * weights.historical +
    factors.transactionPatterns * weights.patterns +
    factors.feedbackQuality * weights.feedback +
    factors.errorRate * weights.errors +
    factors.usageFrequency * weights.usage
  );
}
```

### Testing

**Localização:** `src/test/ml/trust/`
**Frameworks:** Vitest + dados sintéticos
**Cenários de Teste:**
- Cálculo correto de scores com diferentes perfis
- Progressão de níveis de autonomia
- Degradação por erros e recuperação
- Performance com grandes volumes de dados
- Precisão de recomendações

**Validação de ML:**
- Cross-validation com dados históricos
- A/B testing de algoritmos
- Métricas de precisão e recall
- Análise de bias e fairness

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*