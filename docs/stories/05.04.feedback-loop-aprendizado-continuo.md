# Story 05.04: Feedback Loop e Aprendizado Cont√≠nuo

## Status
**Current Status:** Approved  
**Epic:** 05 - Autonomous Financial Intelligence  
**Priority:** Future  
**Estimated Effort:** 4 days  
**Dependencies:** ML infrastructure, Data pipeline, User behavior analytics

---

## Story

**As a** usu√°rio do AegisWallet,  
**I want** que o sistema aprenda continuamente com meu feedback e comportamento,  
**so that** as decis√µes autom√°ticas se tornem cada vez mais precisas e personalizadas ao meu perfil.

---

## Acceptance Criteria

1. [ ] Capturar feedback impl√≠cito (aceitar/rejeitar sugest√µes)
2. [ ] Coletar feedback expl√≠cito via interface amig√°vel
3. [ ] Retreinar modelos semanalmente com novos dados
4. [ ] Personalizar algoritmos baseado no perfil individual
5. [ ] Monitorar melhoria cont√≠nua da precis√£o
6. [ ] Melhoria de precis√£o ‚â•5% a cada trimestre
7. [ ] Tempo de retreinamento <4 horas
8. [ ] Preservar privacidade com aprendizado federado

---

## Tasks / Subtasks

- [ ] **Sistema de Captura de Feedback Impl√≠cito** (AC: 1)
  - [ ] Implementar `src/lib/ml/feedbackCollector.ts` para tracking autom√°tico
  - [ ] Configurar eventos de aceita√ß√£o: usu√°rio n√£o contesta decis√£o em 24h
  - [ ] Adicionar tracking de revers√µes: usu√°rio desfaz a√ß√£o da IA
  - [ ] Implementar coleta de tempo de resposta: aceita r√°pido vs demora
  - [ ] Configurar tracking de padr√µes: usu√°rio repete a√ß√£o sugerida
  - [ ] Adicionar m√©tricas de engajamento: tempo gasto visualizando explica√ß√µes
  - [ ] Implementar coleta de contexto: hor√°rio, dispositivo, localiza√ß√£o
  - [ ] Configurar batch processing para envio eficiente ao backend

- [ ] **Interface de Feedback Expl√≠cito** (AC: 2)
  - [ ] Criar `src/components/feedback/FeedbackWidget.tsx` contextual
  - [ ] Implementar ratings de 1-5 estrelas para cada decis√£o
  - [ ] Adicionar feedback bin√°rio: üëçüëé para a√ß√µes r√°pidas
  - [ ] Configurar feedback textual opcional com sugest√µes
  - [ ] Implementar feedback por categoria: "Muito conservador", "Muito agressivo"
  - [ ] Adicionar feedback de explica√ß√£o: "Entendi", "Confuso", "Incorreto"
  - [ ] Configurar prompts inteligentes: aparecem ap√≥s 3 decis√µes similares
  - [ ] Implementar gamifica√ß√£o: pontos por feedback √∫til

- [ ] **Pipeline de Retreinamento Automatizado** (AC: 3, 7)
  - [ ] Implementar `src/lib/ml/retrainingPipeline.ts` com agenda semanal
  - [ ] Configurar coleta de dados: feedback + decis√µes + outcomes
  - [ ] Adicionar pr√©-processamento: limpeza, normaliza√ß√£o, feature engineering
  - [ ] Implementar valida√ß√£o cruzada: 80% treino, 20% valida√ß√£o
  - [ ] Configurar m√©tricas de avalia√ß√£o: precis√£o, recall, F1-score
  - [ ] Adicionar compara√ß√£o com modelo anterior: A/B testing autom√°tico
  - [ ] Implementar deploy condicional: s√≥ atualiza se melhoria >2%
  - [ ] Configurar rollback autom√°tico se performance degradar

- [ ] **Sistema de Personaliza√ß√£o Adaptativa** (AC: 4, 6)
  - [ ] Implementar `src/lib/ml/personalizer.ts` com perfis individuais
  - [ ] Configurar clustering de usu√°rios: conservador, moderado, agressivo
  - [ ] Adicionar pesos adaptativos por categoria de decis√£o
  - [ ] Implementar transfer learning: novos usu√°rios herdam de cluster
  - [ ] Configurar drift detection: mudan√ßas no comportamento do usu√°rio
  - [ ] Adicionar re-clustering mensal baseado em feedback recente
  - [ ] Implementar cold start: primeiras 10 decis√µes com modelo geral
  - [ ] Configurar m√©tricas de personaliza√ß√£o: melhoria vs baseline

- [ ] **Infraestrutura de ML** (AC: 3, 7)
  - [ ] Configurar Supabase Edge Functions para processamento ML
  - [ ] Implementar queue de retreinamento com Redis/Supabase
  - [ ] Adicionar armazenamento de modelos: versioning e rollback
  - [ ] Configurar monitoramento de performance: lat√™ncia, throughput
  - [ ] Implementar cache de predi√ß√µes: TTL baseado em volatilidade
  - [ ] Adicionar health checks para pipeline de ML
  - [ ] Configurar alertas para falhas de retreinamento
  - [ ] Implementar backup autom√°tico de modelos cr√≠ticos

- [ ] **Privacidade e Seguran√ßa** (AC: 8)
  - [ ] Implementar differential privacy para dados de treinamento
  - [ ] Configurar anonimiza√ß√£o: hash de IDs, remo√ß√£o de PII
  - [ ] Adicionar federated learning: modelos locais + agrega√ß√£o
  - [ ] Implementar auditoria de modelos: bias detection, fairness metrics
  - [ ] Configurar reten√ß√£o de dados: 12 meses para feedback, 24 para modelos
  - [ ] Adicionar consentimento granular: opt-out por tipo de aprendizado
  - [ ] Implementar right to be forgotten: remo√ß√£o de dados espec√≠ficos
  - [ ] Configurar compliance LGPD: relat√≥rios de uso de dados

---

## Dev Notes

### Arquitetura ML Completa

**Estrutura de Arquivos:**
- `src/lib/ml/feedbackCollector.ts` - Coleta de feedback
- `src/lib/ml/retrainingPipeline.ts` - Pipeline de retreinamento
- `src/lib/ml/personalizer.ts` - Personaliza√ß√£o por usu√°rio
- `src/lib/ml/modelManager.ts` - Gerenciamento de modelos
- `supabase/functions/ml-training/` - Edge Functions para ML
- `src/lib/ml/privacyEngine.ts` - Privacidade e anonimiza√ß√£o

### Pipeline de ML Especificado

**Framework Escolhido:**
```typescript
// Usando TensorFlow.js para ML no edge
import * as tf from '@tensorflow/tfjs';
import '@tensorflow/tfjs-backend-webgl';

// src/lib/ml/retrainingPipeline.ts
interface TrainingData {
  features: number[][];
  labels: number[];
  userIds: string[];
  timestamps: string[];
}

interface ModelMetrics {
  accuracy: number;
  precision: number;
  recall: number;
  f1Score: number;
  auc: number;
}

class RetrainingPipeline {
  private currentModel: tf.LayersModel | null = null;
  private modelVersion: string = 'v1.0.0';

  async collectTrainingData(timeRange: string): Promise<TrainingData> {
    // 1. Buscar feedback dos √∫ltimos 7 dias
    const feedback = await this.supabase
      .from('user_feedback')
      .select(`
        *,
        autonomous_decisions (
          decision_factors,
          confidence_score,
          execution_status,
          user_id
        )
      `)
      .gte('created_at', timeRange);

    // 2. Converter para features num√©ricas
    const features = feedback.map(f => this.extractFeatures(f));
    const labels = feedback.map(f => this.extractLabel(f));

    return { features, labels, userIds: feedback.map(f => f.user_id), timestamps: feedback.map(f => f.created_at) };
  }

  async trainModel(data: TrainingData): Promise<ModelMetrics> {
    // 1. Preparar dados
    const xs = tf.tensor2d(data.features);
    const ys = tf.tensor1d(data.labels);

    // 2. Definir arquitetura
    const model = tf.sequential({
      layers: [
        tf.layers.dense({ inputShape: [data.features[0].length], units: 64, activation: 'relu' }),
        tf.layers.dropout({ rate: 0.2 }),
        tf.layers.dense({ units: 32, activation: 'relu' }),
        tf.layers.dropout({ rate: 0.2 }),
        tf.layers.dense({ units: 1, activation: 'sigmoid' })
      ]
    });

    // 3. Compilar modelo
    model.compile({
      optimizer: tf.train.adam(0.001),
      loss: 'binaryCrossentropy',
      metrics: ['accuracy']
    });

    // 4. Treinar
    const history = await model.fit(xs, ys, {
      epochs: 50,
      batchSize: 32,
      validationSplit: 0.2,
      callbacks: {
        onEpochEnd: (epoch, logs) => {
          console.log(`Epoch ${epoch}: loss = ${logs?.loss}, accuracy = ${logs?.acc}`);
        }
      }
    });

    // 5. Avaliar
    const metrics = await this.evaluateModel(model, xs, ys);

    // 6. Salvar se melhor que anterior
    if (this.shouldUpdateModel(metrics)) {
      await this.saveModel(model);
      this.currentModel = model;
    }

    return metrics;
  }

  private extractFeatures(feedback: any): number[] {
    const decision = feedback.autonomous_decisions;
    return [
      decision.decision_factors.trustFactor || 0,
      decision.decision_factors.amountFactor || 0,
      decision.decision_factors.behaviorFactor || 0,
      decision.decision_factors.timingFactor || 0,
      decision.confidence_score || 0,
      feedback.rating || 3, // neutral default
      decision.execution_status === 'executed' ? 1 : 0,
      // ... mais features
    ];
  }

  private extractLabel(feedback: any): number {
    // Converter feedback para label bin√°rio
    if (feedback.feedback_type === 'implicit') {
      return feedback.rating >= 3 ? 1 : 0; // aceito vs rejeitado
    } else {
      return feedback.rating >= 4 ? 1 : 0; // satisfeito vs insatisfeito
    }
  }
}
```

### Schema Supabase Expandido

```sql
-- Feedback do usu√°rio (expandido)
CREATE TABLE user_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  decision_id UUID REFERENCES autonomous_decisions(id),

  -- Tipo de feedback
  feedback_type TEXT NOT NULL CHECK (feedback_type IN ('implicit', 'explicit', 'behavioral')),

  -- Feedback expl√≠cito
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  feedback_text TEXT,
  feedback_category TEXT CHECK (feedback_category IN ('accuracy', 'timing', 'amount', 'explanation')),

  -- Feedback impl√≠cito
  action_taken TEXT CHECK (action_taken IN ('accepted', 'rejected', 'modified', 'ignored')),
  response_time_ms INTEGER, -- tempo para reagir √† decis√£o

  -- Contexto
  context_data JSONB, -- dispositivo, localiza√ß√£o, hor√°rio

  -- Metadados
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  processed_at TIMESTAMP WITH TIME ZONE,

  -- √çndices
  CONSTRAINT valid_explicit_feedback CHECK (
    (feedback_type = 'explicit' AND rating IS NOT NULL) OR
    (feedback_type != 'explicit')
  )
);

-- Modelos de ML
CREATE TABLE ml_models (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  version TEXT NOT NULL UNIQUE,
  model_type TEXT NOT NULL CHECK (model_type IN ('decision_classifier', 'personalizer', 'risk_assessor')),

  -- Modelo serializado
  model_data BYTEA, -- modelo TensorFlow.js serializado
  model_metadata JSONB, -- arquitetura, hiperpar√¢metros

  -- M√©tricas de performance
  accuracy DECIMAL(5,4),
  precision DECIMAL(5,4),
  recall DECIMAL(5,4),
  f1_score DECIMAL(5,4),
  auc DECIMAL(5,4),

  -- Dados de treinamento
  training_data_size INTEGER,
  training_duration_ms INTEGER,
  validation_split DECIMAL(3,2) DEFAULT 0.2,

  -- Status
  status TEXT DEFAULT 'training' CHECK (status IN ('training', 'validating', 'active', 'deprecated')),
  deployed_at TIMESTAMP WITH TIME ZONE,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Personaliza√ß√£o por usu√°rio
CREATE TABLE user_personalization (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),

  -- Cluster do usu√°rio
  user_cluster TEXT CHECK (user_cluster IN ('conservative', 'moderate', 'aggressive', 'custom')),
  cluster_confidence DECIMAL(3,2),

  -- Pesos personalizados
  trust_weight DECIMAL(3,2) DEFAULT 0.35,
  amount_weight DECIMAL(3,2) DEFAULT 0.25,
  behavior_weight DECIMAL(3,2) DEFAULT 0.20,
  timing_weight DECIMAL(3,2) DEFAULT 0.15,
  context_weight DECIMAL(3,2) DEFAULT 0.05,

  -- M√©tricas de personaliza√ß√£o
  personalization_score DECIMAL(5,4), -- qu√£o personalizado est√°
  improvement_over_baseline DECIMAL(5,4), -- melhoria vs modelo geral

  -- Metadados
  last_updated TIMESTAMP WITH TIME ZONE DEFAULT now(),
  feedback_count INTEGER DEFAULT 0,

  UNIQUE(user_id)
);

-- Jobs de retreinamento
CREATE TABLE ml_training_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_type TEXT NOT NULL CHECK (job_type IN ('weekly_retrain', 'user_personalization', 'model_validation')),

  -- Status do job
  status TEXT DEFAULT 'queued' CHECK (status IN ('queued', 'running', 'completed', 'failed')),

  -- Configura√ß√£o
  config JSONB, -- par√¢metros do treinamento

  -- Resultados
  metrics JSONB, -- m√©tricas de performance
  model_version TEXT,

  -- Timing
  started_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  duration_ms INTEGER,

  -- Logs
  logs TEXT,
  error_message TEXT,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Cria√ß√£o inicial da story | PM Agent "John" |