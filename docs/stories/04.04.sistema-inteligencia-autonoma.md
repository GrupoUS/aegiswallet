# Story 04.04: Sistema de Intelig√™ncia Aut√¥noma

<!-- REFINAMENTO SM: Integra√ß√£o com backend especificada, componentes detalhados, mock vs real definido -->

## Status
**Current Status:** Draft
**Epic:** 04 - Frontend Implementation
**Priority:** Medium
**Estimated Effort:** 5 days
**Dependencies:** AI status backend procedures, User preference system, Security monitoring

---

## Story

**As a** usu√°rio do AegisWallet,
**I want** uma interface completa que visualize e controle a intelig√™ncia artificial aut√¥noma do sistema,
**so that** eu possa entender, confiar e ajustar o n√≠vel de automa√ß√£o conforme minha evolu√ß√£o de confian√ßa.

---

## Acceptance Criteria

1. [ ] Implementar Trust Level Progress indicator (0-100%)
2. [ ] Criar AI Activity indicators transparentes
3. [ ] Desenvolver AI Decision transparency system
4. [ ] Adicionar Personalization & Learning visualization
5. [ ] Implementar Autonomous Operation dashboard
6. [ ] Criar Security indicators para opera√ß√µes aut√¥nomas
7. [ ] Integrar com ML/AI backend (mock inicial)
8. [ ] Interface responsiva e acess√≠vel WCAG 2.1 AA+

---

## Tasks / Subtasks

- [ ] **Componente Trust Level Progress** (AC: 1)
  - [ ] Criar `src/components/ai/TrustMeter.tsx` com progresso circular
  - [ ] Implementar hook `useTrustScore()` conectado ao tRPC
  - [ ] Configurar anima√ß√£o suave com Framer Motion (0.3s ease-out)
  - [ ] Adicionar breakdown visual: consist√™ncia, precis√£o, tempo de uso, feedback
  - [ ] Implementar cores din√¢micas: <60 vermelho, 60-80 amarelo, >80 verde
  - [ ] Criar mini-gr√°fico de evolu√ß√£o (√∫ltimos 30 dias)
  - [ ] Adicionar tooltip explicativo para cada fator
  - [ ] Configurar atualiza√ß√£o em tempo real via Supabase subscriptions

- [ ] **Feed de Atividades da IA** (AC: 2)
  - [ ] Criar `src/components/ai/ActivityFeed.tsx` com timeline vertical
  - [ ] Implementar `useAIActivity()` hook para dados em tempo real
  - [ ] Configurar √≠cones espec√≠ficos: üí∞ pagamento, üìä an√°lise, ‚ö†Ô∏è alerta
  - [ ] Adicionar status indicators: üü¢ ativo, üü° aprendendo, üî¥ pausado
  - [ ] Implementar filtros: √∫ltimas 24h, 7 dias, 30 dias
  - [ ] Configurar pagina√ß√£o virtual para performance
  - [ ] Adicionar a√ß√µes r√°pidas: "Ver detalhes", "Contestar decis√£o"
  - [ ] Implementar notifica√ß√µes toast para a√ß√µes importantes

- [ ] **Sistema de Explica√ß√£o de Decis√µes** (AC: 3)
  - [ ] Criar `src/components/ai/DecisionExplainer.tsx` com cards expand√≠veis
  - [ ] Implementar `useDecisionExplanation(decisionId)` hook
  - [ ] Configurar se√ß√£o "Por que a IA fez isso?" com linguagem natural
  - [ ] Adicionar visualiza√ß√£o de dados utilizados (gr√°ficos simples)
  - [ ] Implementar n√≠veis de detalhamento: b√°sico, intermedi√°rio, t√©cnico
  - [ ] Configurar drill-down para dados originais (transa√ß√µes, padr√µes)
  - [ ] Adicionar bot√µes de feedback: "√ötil", "Confuso", "Incorreto"
  - [ ] Implementar export de explica√ß√£o para PDF

- [ ] **Dashboard de Personaliza√ß√£o** (AC: 4)
  - [ ] Criar `src/components/ai/PersonalizationDashboard.tsx`
  - [ ] Implementar `usePersonalizationData()` para padr√µes aprendidos
  - [ ] Configurar cards de prefer√™ncias: hor√°rios, valores, categorias
  - [ ] Adicionar gr√°fico de evolu√ß√£o do aprendizado (line chart)
  - [ ] Implementar indicadores de precis√£o por categoria
  - [ ] Configurar visualiza√ß√£o de "Coisas que a IA aprendeu sobre voc√™"
  - [ ] Adicionar controles para corrigir prefer√™ncias detectadas
  - [ ] Implementar feedback loop: "Isso est√° correto?"

- [ ] **Dashboard de Opera√ß√µes Aut√¥nomas** (AC: 5)
  - [ ] Criar `src/components/ai/AutonomyDashboard.tsx` com m√©tricas
  - [ ] Implementar controles deslizantes por categoria (0-100%)
  - [ ] Configurar `useAutonomySettings()` hook para persist√™ncia
  - [ ] Adicionar estat√≠sticas: tempo poupado, a√ß√µes executadas, economia
  - [ ] Implementar simulador: "Se eu aumentar para 90%, o que acontece?"
  - [ ] Configurar alertas visuais para interven√ß√µes necess√°rias
  - [ ] Adicionar hist√≥rico de mudan√ßas de configura√ß√£o
  - [ ] Implementar modo "Pausa Geral" para emerg√™ncias

- [ ] **Indicadores de Seguran√ßa** (AC: 6, 8)
  - [ ] Criar `src/components/ai/SecurityIndicators.tsx`
  - [ ] Implementar `useSecurityStatus()` para monitoramento
  - [ ] Configurar indicadores de risco: baixo, m√©dio, alto, cr√≠tico
  - [ ] Adicionar alertas em tempo real para opera√ß√µes suspeitas
  - [ ] Implementar log de a√ß√µes de seguran√ßa (√∫ltimas 100)
  - [ ] Configurar kill switch: "Parar Toda Automa√ß√£o"
  - [ ] Adicionar confirma√ß√£o dupla para a√ß√µes cr√≠ticas
  - [ ] Implementar modo de auditoria: registra tudo, n√£o executa

- [ ] **Integra√ß√£o com Backend de IA** (AC: 7)
  - [ ] Configurar tRPC procedures: `ai.getTrustScore`, `ai.getActivity`
  - [ ] Implementar mock data em `src/lib/ai/mockData.ts` para desenvolvimento
  - [ ] Configurar Supabase subscriptions para updates em tempo real
  - [ ] Adicionar error boundaries para falhas de API
  - [ ] Implementar fallback para dados offline (cache local)
  - [ ] Configurar retry logic para chamadas falhadas
  - [ ] Adicionar loading states para todas as opera√ß√µes
  - [ ] Implementar rate limiting no frontend (max 10 req/min)

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/components/ui/` - Componentes base shadcn/ui
- `src/hooks/` - Hooks React existentes
- `src/server/procedures/` - APIs tRPC

**Novos Componentes Detalhados:**
- `src/components/ai/TrustMeter.tsx` - Medidor de confian√ßa circular
- `src/components/ai/ActivityFeed.tsx` - Feed de atividades em tempo real
- `src/components/ai/DecisionExplainer.tsx` - Explicador de decis√µes
- `src/components/ai/PersonalizationDashboard.tsx` - Dashboard de personaliza√ß√£o
- `src/components/ai/AutonomyControls.tsx` - Controles de autonomia
- `src/components/ai/SecurityIndicators.tsx` - Indicadores de seguran√ßa

**Hooks Necess√°rios:**
- `src/hooks/useAIStatus.ts` - Status da IA
- `src/hooks/useTrustScore.ts` - Score de confian√ßa
- `src/hooks/useAIDecisions.ts` - Decis√µes da IA
- `src/hooks/useAutonomySettings.ts` - Configura√ß√µes de autonomia

### Integra√ß√£o com Backend de IA Especificada

**tRPC Procedures Necess√°rios:**
```typescript
// src/server/procedures/ai.ts
export const aiRouter = router({
  // Trust Score
  getTrustScore: protectedProcedure
    .query(async ({ ctx }) => {
      const { data, error } = await ctx.supabase
        .from('user_trust_scores')
        .select('*')
        .eq('user_id', ctx.user.id)
        .single();

      return data || mockTrustScore;
    }),

  // AI Activity Feed
  getActivity: protectedProcedure
    .input(z.object({
      limit: z.number().default(20),
      offset: z.number().default(0),
      filter: z.enum(['all', 'payments', 'alerts', 'analysis']).default('all')
    }))
    .query(async ({ ctx, input }) => {
      const { data } = await ctx.supabase
        .from('ai_activities')
        .select('*')
        .eq('user_id', ctx.user.id)
        .order('created_at', { ascending: false })
        .range(input.offset, input.offset + input.limit - 1);

      return data || mockActivityData;
    }),

  // Decision Explanations
  getDecisionExplanation: protectedProcedure
    .input(z.object({ decisionId: z.string() }))
    .query(async ({ ctx, input }) => {
      const { data } = await ctx.supabase
        .from('ai_decision_explanations')
        .select('*')
        .eq('decision_id', input.decisionId)
        .single();

      return data || mockExplanation;
    }),

  // Autonomy Settings
  getAutonomySettings: protectedProcedure
    .query(async ({ ctx }) => {
      const { data } = await ctx.supabase
        .from('user_autonomy_settings')
        .select('*')
        .eq('user_id', ctx.user.id)
        .single();

      return data || defaultAutonomySettings;
    }),

  updateAutonomySettings: protectedProcedure
    .input(z.object({
      payments: z.number().min(0).max(100),
      categorization: z.number().min(0).max(100),
      recommendations: z.number().min(0).max(100),
      alerts: z.number().min(0).max(100)
    }))
    .mutation(async ({ ctx, input }) => {
      const { data, error } = await ctx.supabase
        .from('user_autonomy_settings')
        .upsert({
          user_id: ctx.user.id,
          ...input,
          updated_at: new Date().toISOString()
        })
        .select()
        .single();

      if (error) throw new TRPCError({
        code: 'BAD_REQUEST',
        message: error.message
      });

      return data;
    })
});
```

**Mock Data para Desenvolvimento:**
```typescript
// src/lib/ai/mockData.ts
export const mockTrustScore = {
  current: 75,
  trend: 'increasing' as const,
  factors: {
    consistency: 85,
    accuracy: 70,
    userFeedback: 80,
    timeUsing: 65
  },
  history: [
    { date: '2025-09-01', score: 45 },
    { date: '2025-09-15', score: 60 },
    { date: '2025-10-01', score: 75 }
  ]
};

export const mockActivityData = [
  {
    id: '1',
    type: 'payment',
    action: 'Paguei conta de energia el√©trica',
    confidence: 0.95,
    outcome: 'success',
    timestamp: '2025-10-04T10:30:00Z',
    amount: 150.00
  },
  {
    id: '2',
    type: 'alert',
    action: 'Alertei sobre oportunidade de economia',
    confidence: 0.88,
    outcome: 'acknowledged',
    timestamp: '2025-10-04T09:15:00Z',
    savings: 45.00
  }
];

export const mockExplanation = {
  decision: 'Paguei sua conta de energia el√©trica',
  reasoning: [
    'Voc√™ sempre paga esta conta no dia 4 de cada m√™s',
    'Seu saldo atual (R$ 2.450) √© suficiente',
    'O valor (R$ 150) est√° dentro do padr√£o hist√≥rico',
    'Seu n√≠vel de confian√ßa (75%) permite esta automa√ß√£o'
  ],
  dataUsed: [
    'Hist√≥rico de pagamentos (√∫ltimos 6 meses)',
    'Saldo atual da conta corrente',
    'Padr√£o de gastos com energia',
    'Configura√ß√µes de autonomia'
  ],
  confidence: 0.95,
  riskLevel: 'low'
};
```

**Interfaces TypeScript:**
```typescript
interface TrustScore {
  current: number; // 0-100
  trend: 'increasing' | 'decreasing' | 'stable';
  factors: {
    consistency: number;
    accuracy: number;
    userFeedback: number;
    timeUsing: number;
  };
  history: TrustHistoryPoint[];
}

interface AIDecision {
  id: string;
  type: 'payment' | 'categorization' | 'recommendation' | 'alert';
  action: string;
  confidence: number;
  reasoning: string;
  dataUsed: string[];
  outcome: 'success' | 'failure' | 'pending';
  userFeedback?: 'positive' | 'negative' | 'neutral';
  timestamp: string;
}

interface AutonomySettings {
  payments: number; // 0-100
  categorization: number;
  recommendations: number;
  alerts: number;
  globalPause: boolean;
  emergencyStop: boolean;
}
```

### Visualiza√ß√µes de IA

**Trust Meter Design:**
- C√≠rculo progressivo com gradiente de cores
- Breakdown visual dos fatores de confian√ßa
- Anima√ß√µes suaves para mudan√ßas
- Tooltips explicativos
- Hist√≥rico em mini-gr√°fico

**Activity Feed:**
- Timeline vertical com a√ß√µes recentes
- √çcones espec√≠ficos por tipo de a√ß√£o
- Status colorido (sucesso, falha, pendente)
- Expandir/colapsar para detalhes
- Filtros por categoria e per√≠odo

**Decision Explainer:**
- Cards expand√≠veis para cada decis√£o
- Visualiza√ß√£o de dados utilizados
- Linguagem natural para explica√ß√µes
- Links para dados originais
- Op√ß√£o de feedback do usu√°rio

### Sistema de Transpar√™ncia

**Linguagem Natural:**
```typescript
const explanationTemplates = {
  payment: "Executei este pagamento porque identifiquei um padr√£o recorrente de {frequency} e voc√™ tem saldo suficiente ({balance}). Baseei-me no seu hist√≥rico dos √∫ltimos {months} meses.",
  categorization: "Categorizei como '{category}' porque a descri√ß√£o '{description}' √© similar a outras transa√ß√µes que voc√™ confirmou nesta categoria.",
  recommendation: "Recomendo {action} porque detectei uma oportunidade de economia de R$ {amount} baseado no seu padr√£o de gastos."
};
```

**Dados Utilizados:**
- Hist√≥rico de transa√ß√µes
- Padr√µes de comportamento
- Feedback anterior do usu√°rio
- Dados de contexto (saldo, data, etc.)
- Compara√ß√£o com usu√°rios similares (anonimizado)

### Controles de Autonomia

**N√≠veis por Categoria:**
- **Pagamentos**: 0% (manual) ‚Üí 100% (totalmente autom√°tico)
- **Categoriza√ß√£o**: 0% (manual) ‚Üí 100% (autom√°tica)
- **Recomenda√ß√µes**: 0% (desligadas) ‚Üí 100% (proativas)
- **Alertas**: 0% (m√≠nimos) ‚Üí 100% (todos os insights)

**Controles de Seguran√ßa:**
- Kill Switch: Para toda automa√ß√£o imediatamente
- Pause: Pausa tempor√°ria (1h, 1d, 1w)
- Rollback: Desfaz √∫ltimas N decis√µes
- Audit Mode: Registra tudo mas n√£o executa

### Testing

**Localiza√ß√£o:** `src/test/components/ai/`
**Frameworks:** Vitest + Testing Library + Storybook
**Cen√°rios de Teste:**
- Renderiza√ß√£o correta de diferentes n√≠veis de confian√ßa
- Funcionamento dos controles de autonomia
- Explica√ß√µes claras para diferentes tipos de decis√£o
- Responsividade em diferentes dispositivos
- Acessibilidade com screen readers

**Testes de Usabilidade:**
- Clareza das explica√ß√µes da IA
- Facilidade de ajuste dos controles
- Compreens√£o dos indicadores de seguran√ßa
- Efic√°cia do feedback loop

**M√©tricas de Qualidade:**
- Compreens√£o das explica√ß√µes >90%
- Satisfa√ß√£o com transpar√™ncia >4.5/5
- Uso dos controles de autonomia >70%
- Confian√ßa na IA ap√≥s uso >80%

### Integra√ß√£o com Backend

**APIs Mock Iniciais:**
```typescript
// Mock data para desenvolvimento
const mockAIStatus = {
  trustScore: 75,
  isActive: true,
  lastDecision: '2025-10-04T10:30:00Z',
  totalDecisions: 1247,
  successRate: 94.2
};

const mockDecisions = [
  {
    id: '1',
    type: 'payment',
    action: 'Paguei conta de energia el√©trica',
    confidence: 0.95,
    reasoning: 'Padr√£o recorrente mensal detectado',
    outcome: 'success'
  }
];
```

**Integra√ß√£o Real (Futura):**
- APIs tRPC para dados de IA
- WebSocket para updates em tempo real
- Supabase subscriptions para mudan√ßas
- Analytics para m√©tricas de uso

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Cria√ß√£o inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta se√ß√£o ser√° preenchida pelo agente de desenvolvimento durante a implementa√ß√£o*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta se√ß√£o ser√° preenchida pelo agente de QA ap√≥s revis√£o da implementa√ß√£o*