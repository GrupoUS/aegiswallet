# Story 03.01: Motor de Orquestração de Pagamentos

## Status
**Current Status:** ✅ Completed (Core Infrastructure)
**Epic:** 03 - Smart Payment Automation
**Priority:** High
**Estimated Effort:** 6 days
**Actual Effort:** 1 day (6 hours)
**Completed Date:** 2025-01-04
**Dependencies:** Núcleo de Integração Bancária, Voice Interface, Supabase cron jobs
**Note:** Core orchestration infrastructure complete with autonomy levels (50%, 75%, 95%). PIX/Boleto execution requires payment provider integration.

---

## Story

**As a** usuário do AegisWallet,  
**I want** que o sistema gerencie automaticamente meus pagamentos recorrentes com base no meu nível de confiança configurado,  
**so that** eu nunca mais esqueça de pagar contas importantes e possa focar em decisões financeiras mais estratégicas.

---

## Acceptance Criteria

1. [ ] Configuração de regras por conta (valor máximo, tolerância, horário preferido)
2. [ ] Suporte a níveis de autonomia (50%, 75%, 95%) com workflows de aprovação
3. [ ] Execução automática com retries e fallback manual em caso de falha
4. [ ] Logs detalhados para cada tentativa de pagamento
5. [ ] Testes automatizados cobrindo casos de sucesso, falha e limites
6. [ ] Taxa de execução bem-sucedida ≥99% para pagamentos agendados
7. [ ] Tempo de processamento <5 segundos para pagamentos PIX
8. [ ] Notificações proativas antes e após cada pagamento

---

## Tasks / Subtasks

- [ ] **Sistema de Configuração de Regras** (AC: 1)
  - [ ] Criar interface para configurar regras por conta/beneficiário
  - [ ] Implementar validação de limites e tolerâncias
  - [ ] Adicionar configuração de horários preferenciais
  - [ ] Criar templates de regras para contas comuns
  - [ ] Implementar herança de regras por categoria

- [ ] **Níveis de Autonomia e Workflows** (AC: 2)
  - [ ] Implementar matriz de decisão por nível de autonomia
  - [ ] Criar workflows de aprovação para cada nível
  - [ ] Adicionar confirmação por voz para nível 50%
  - [ ] Implementar aprovação automática para nível 95%
  - [ ] Configurar escalation para valores acima do limite

- [ ] **Engine de Execução de Pagamentos** (AC: 3, 6, 7)
  - [ ] Implementar scheduler para pagamentos agendados
  - [ ] Adicionar retry logic com exponential backoff
  - [ ] Criar fallback para aprovação manual em falhas
  - [ ] Implementar circuit breaker por provedor de pagamento
  - [ ] Otimizar performance para <5s de processamento

- [ ] **Sistema de Logging e Auditoria** (AC: 4)
  - [ ] Implementar logging estruturado para cada operação
  - [ ] Adicionar tracking de estado de pagamento
  - [ ] Criar trilha de auditoria para compliance
  - [ ] Implementar assinatura digital para logs críticos
  - [ ] Configurar retenção de logs por 5 anos

- [ ] **Sistema de Notificações** (AC: 8)
  - [ ] Implementar notificações pré-pagamento (24h antes)
  - [ ] Adicionar confirmação pós-pagamento imediata
  - [ ] Criar alertas para falhas de pagamento
  - [ ] Implementar notificações por múltiplos canais
  - [ ] Configurar preferências de notificação por usuário

---

## Dev Notes

### Arquitetura Relevante

**Estrutura Atual:**
- `src/lib/banking/pixApi.ts` - API PIX (stub implementado)
- `src/server/procedures/` - Procedures tRPC existentes
- `supabase/migrations/` - Schema de transações existente

**Novos Arquivos Necessários:**
- `src/lib/payments/orchestrator.ts` - Motor principal de orquestração
- `src/lib/payments/ruleEngine.ts` - Engine de regras de pagamento
- `src/lib/payments/scheduler.ts` - Agendador de pagamentos
- `src/lib/payments/notificationService.ts` - Serviço de notificações
- `src/server/procedures/payments.ts` - Procedures tRPC para pagamentos

**Schema do Supabase:**
```sql
-- Tabela para regras de pagamento
CREATE TABLE payment_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  payee_name TEXT NOT NULL,
  payee_key TEXT, -- PIX key ou código de barras
  max_amount DECIMAL(10,2) NOT NULL,
  tolerance_percentage INTEGER DEFAULT 5,
  preferred_time TIME DEFAULT '09:00:00',
  autonomy_level INTEGER CHECK (autonomy_level IN (50, 75, 95)),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para pagamentos agendados
CREATE TABLE scheduled_payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  rule_id UUID REFERENCES payment_rules(id),
  amount DECIMAL(10,2) NOT NULL,
  due_date DATE NOT NULL,
  scheduled_time TIMESTAMP WITH TIME ZONE,
  status TEXT NOT NULL CHECK (status IN ('pending', 'approved', 'executed', 'failed', 'cancelled')),
  execution_attempts INTEGER DEFAULT 0,
  last_attempt_at TIMESTAMP WITH TIME ZONE,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Tabela para logs de pagamento
CREATE TABLE payment_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  payment_id UUID REFERENCES scheduled_payments(id),
  action TEXT NOT NULL,
  status TEXT NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### Lógica de Autonomia

**Nível 50% (Assistido):**
- Confirmação obrigatória por voz ou app
- Limite máximo: R$ 500 por transação
- Notificação 24h antes + confirmação

**Nível 75% (Semi-autônomo):**
- Execução automática até R$ 1.000
- Confirmação apenas para valores acima
- Notificação 2h antes da execução

**Nível 95% (Autônomo):**
- Execução automática até R$ 5.000
- Apenas notificação pós-execução
- Intervenção manual apenas para anomalias

### Testing

**Localização:** `src/test/payments/orchestrator/`
**Frameworks:** Vitest para lógica, Playwright para fluxos E2E
**Cenários de Teste Críticos:**
- Execução automática por nível de autonomia
- Falhas de pagamento e recovery
- Limites e validações de regras
- Notificações em diferentes cenários
- Performance com múltiplos pagamentos simultâneos

**Testes de Segurança:**
- Validação de limites por usuário
- Prevenção de double-spending
- Auditoria de logs críticos
- Isolamento de dados entre usuários

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*