# Story 01.02: NLU dos 6 Comandos Essenciais

## Status
**Current Status:** Draft  
**Epic:** 01 - Voice Interface Foundation  
**Priority:** Critical  
**Estimated Effort:** 6 days  
**Dependencies:** voiceCommandProcessor, AI transaction insights, banking connectors

---

## Story

**As a** usuário do AegisWallet,  
**I want** que o sistema entenda minhas intenções quando falo comandos financeiros em português natural,  
**so that** eu possa usar expressões cotidianas como "quanto posso gastar?" ou "paga o boleto da energia" sem precisar decorar comandos específicos.

---

## Acceptance Criteria

1. [ ] Definir intents e entidades para cada comando (saldo, orçamento, boletos, recebimentos, projeção, transferência)
2. [ ] Suportar expressões comuns ("quanto posso gastar?", "meu saldo hoje?", "paga o boleto da energia")
3. [ ] Implementar mecanismo de desambiguação e confirmação quando necessário
4. [ ] Cobertura de testes >95% de frases pré-definidas
5. [ ] Logs de falsos positivos/negativos para re-treinamento
6. [ ] Precisão de classificação de intenção ≥90%
7. [ ] Tempo de processamento NLU <200ms
8. [ ] Suporte a variações regionais do português brasileiro

---

## Tasks / Subtasks

- [ ] **Definição de Intents e Entidades** (AC: 1)
  - [ ] Mapear os 6 comandos essenciais para intents estruturadas
  - [ ] Definir entidades (valores, datas, beneficiários, categorias)
  - [ ] Criar schema de slots para cada intent
  - [ ] Documentar exemplos de utterances por intent
  - [ ] Implementar validação de entidades extraídas

- [ ] **Dataset de Expressões Brasileiras** (AC: 2, 8)
  - [ ] Coletar 50+ variações por comando de diferentes regiões
  - [ ] Incluir gírias e expressões coloquiais brasileiras
  - [ ] Mapear sinônimos regionais (ex: "grana", "dinheiro", "real")
  - [ ] Criar dataset de teste com expressões ambíguas
  - [ ] Implementar normalização de texto (acentos, abreviações)

- [ ] **Motor de Classificação de Intenção** (AC: 6, 7)
  - [ ] Implementar classificador baseado em padrões regex otimizados
  - [ ] Adicionar scoring de confiança para cada classificação
  - [ ] Implementar fallback para classificação por similaridade
  - [ ] Otimizar performance para <200ms de processamento
  - [ ] Criar cache de classificações frequentes

- [ ] **Sistema de Desambiguação** (AC: 3)
  - [ ] Detectar comandos ambíguos ou incompletos
  - [ ] Implementar diálogo de clarificação por voz
  - [ ] Criar templates de perguntas de confirmação
  - [ ] Implementar timeout para respostas de clarificação
  - [ ] Adicionar opção de cancelamento de comando

- [ ] **Logging e Monitoramento** (AC: 4, 5)
  - [ ] Implementar logging estruturado de classificações
  - [ ] Capturar falsos positivos/negativos com feedback do usuário
  - [ ] Criar dashboard de métricas de precisão por comando
  - [ ] Implementar alertas para queda de performance
  - [ ] Configurar coleta de dados para re-treinamento

---

## Dev Notes

### Arquitetura Relevante

**Arquivos Principais:**
- `src/lib/voiceCommandProcessor.ts` - Processador principal (já existe, precisa expansão)
- `src/hooks/useVoiceRecognition.ts` - Hook de reconhecimento (integração)
- `src/components/voice/VoiceDashboard.tsx` - Interface de feedback

**Novos Arquivos Necessários:**
- `src/lib/nlu/intentClassifier.ts` - Classificador de intenções
- `src/lib/nlu/entityExtractor.ts` - Extrator de entidades
- `src/lib/nlu/dialogManager.ts` - Gerenciador de diálogo
- `src/lib/nlu/utteranceDataset.ts` - Dataset de expressões

**Integrações:**
- tRPC procedures para dados financeiros contextuais
- Supabase para logging de interações e feedback
- Sistema de notificações para confirmações

### Padrões de Implementação

**Estrutura de Intent:**
```typescript
interface Intent {
  name: string;
  confidence: number;
  entities: Record<string, any>;
  requiresConfirmation: boolean;
}
```

**Fluxo de Processamento:**
1. Normalização do texto transcrito
2. Classificação de intenção com scoring
3. Extração de entidades relevantes
4. Validação e desambiguação se necessário
5. Execução do comando ou solicitação de clarificação

### Testing

**Localização:** `src/test/nlu/`
**Frameworks:** Vitest para lógica, Playwright para fluxos E2E
**Datasets de Teste:**
- 500+ expressões categorizadas por intent
- Casos ambíguos e edge cases
- Variações regionais brasileiras
- Comandos com entidades faltantes

**Métricas de Qualidade:**
- Precisão por intent ≥90%
- Recall por intent ≥85%
- F1-score geral ≥87%
- Latência média <200ms

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*