# Story 01.02: NLU dos 6 Comandos Essenciais

<!-- REFINAMENTO SM: Framework NLU especificado, decomposição atômica, exemplos de código -->

## Status
**Current Status:** Approved
**Epic:** 01 - Voice Interface Foundation
**Priority:** Critical
**Estimated Effort:** 6 days
**Dependencies:** voiceCommandProcessor, AI transaction insights, banking connectors

---

## Story

**As a** usuário do AegisWallet,
**I want** que o sistema entenda minhas intenções quando falo comandos financeiros em português natural,
**so that** eu possa usar expressões cotidianas como "quanto posso gastar?" ou "paga o boleto da energia" sem precisar decorar comandos específicos.

---

## Acceptance Criteria

1. [ ] Definir intents e entidades para cada comando (saldo, orçamento, boletos, recebimentos, projeção, transferência)
2. [ ] Suportar expressões comuns ("quanto posso gastar?", "meu saldo hoje?", "paga o boleto da energia")
3. [ ] Implementar mecanismo de desambiguação e confirmação quando necessário
4. [ ] Cobertura de testes >95% de frases pré-definidas
5. [ ] Logs de falsos positivos/negativos para re-treinamento
6. [ ] Precisão de classificação de intenção ≥90%
7. [ ] Tempo de processamento NLU <200ms
8. [ ] Suporte a variações regionais do português brasileiro

---

## Tasks / Subtasks

- [ ] **Configuração do Framework NLU** (AC: 1, 7)
  - [ ] Instalar e configurar biblioteca `compromise` para NLP em português
  - [ ] Configurar `natural` para classificação de texto e stemming
  - [ ] Implementar `src/lib/nlu/nluEngine.ts` com interface NLUEngine
  - [ ] Configurar pipeline: tokenização → normalização → classificação → extração
  - [ ] Implementar cache Redis para classificações (TTL: 1 hora)
  - [ ] Configurar timeout de 150ms para processamento
  - [ ] Adicionar fallback para classificação simples por keywords
  - [ ] Implementar health check para monitoramento

- [ ] **Definição de Intents Estruturadas** (AC: 1)
  - [ ] Criar arquivo `src/lib/nlu/intents.ts` com 6 intents principais
  - [ ] Definir intent `CHECK_BALANCE` com slots: [account?, date?]
  - [ ] Definir intent `CHECK_BUDGET` com slots: [category?, period?]
  - [ ] Definir intent `PAY_BILL` com slots: [bill_type, amount?, date?]
  - [ ] Definir intent `CHECK_INCOME` com slots: [source?, period?]
  - [ ] Definir intent `FINANCIAL_PROJECTION` com slots: [period, category?]
  - [ ] Definir intent `TRANSFER_MONEY` com slots: [recipient, amount, date?]
  - [ ] Implementar validação de slots obrigatórios vs opcionais
  - [ ] Criar mapeamento de intents para ações do sistema

- [ ] **Sistema de Entidades (NER)** (AC: 1)
  - [ ] Implementar `src/lib/nlu/entityExtractor.ts` com regex patterns
  - [ ] Configurar extração de valores: "R$ 100", "cem reais", "cinquenta"
  - [ ] Implementar extração de datas: "hoje", "amanhã", "próxima sexta"
  - [ ] Adicionar extração de nomes: "João", "Maria Silva", "minha mãe"
  - [ ] Configurar categorias: "energia", "água", "internet", "mercado"
  - [ ] Implementar normalização de entidades extraídas
  - [ ] Adicionar validação de entidades (CPF, telefone, email para PIX)
  - [ ] Configurar confidence score para cada entidade extraída

- [ ] **Dataset de Expressões Brasileiras** (AC: 2, 8)
  - [ ] Criar arquivo `src/data/utterances.json` com 300+ expressões
  - [ ] Coletar 50 variações por intent de diferentes regiões brasileiras
  - [ ] Incluir gírias regionais: "grana" (SP), "dinheiro" (RJ), "real" (formal)
  - [ ] Mapear expressões coloquiais: "tá quanto?", "sobrou quanto?"
  - [ ] Adicionar variações de sotaque: "pagar" vs "pagá", "dinheiro" vs "dinhêro"
  - [ ] Implementar normalização de acentos e contrações
  - [ ] Criar dataset de teste com 100 expressões ambíguas
  - [ ] Validar dataset com falantes nativos de 5 regiões

- [ ] **Motor de Classificação Híbrido** (AC: 6, 7)
  - [ ] Implementar classificador baseado em TF-IDF + cosine similarity
  - [ ] Adicionar classificador por regex patterns para casos específicos
  - [ ] Configurar ensemble voting entre os dois métodos
  - [ ] Implementar confidence threshold: >0.8 aceita, 0.6-0.8 confirma, <0.6 rejeita
  - [ ] Otimizar para latência <150ms usando cache e pré-computação
  - [ ] Implementar fallback para classificação por keywords
  - [ ] Adicionar re-ranking baseado em contexto do usuário
  - [ ] Configurar A/B testing para comparar algoritmos

- [ ] **Sistema de Desambiguação Inteligente** (AC: 3)
  - [ ] Implementar `src/lib/nlu/disambiguator.ts` para casos ambíguos
  - [ ] Criar templates de perguntas: "Você quer pagar qual conta?"
  - [ ] Configurar contexto conversacional com histórico de 3 turnos
  - [ ] Implementar timeout de 30 segundos para confirmações
  - [ ] Adicionar sugestões baseadas em histórico: "Geralmente você paga energia"
  - [ ] Configurar fallback para modo manual com opções visuais
  - [ ] Implementar cancelamento por comando: "cancelar", "deixa pra lá"
  - [ ] Adicionar logging de casos de desambiguação para melhoria

- [ ] **Sistema de Monitoramento e Métricas** (AC: 4, 5, 6)
  - [ ] Implementar `src/lib/nlu/nluMetrics.ts` para tracking
  - [ ] Configurar logging de todas as classificações no Supabase
  - [ ] Implementar métricas em tempo real: precisão, recall, F1-score
  - [ ] Adicionar tracking de falsos positivos/negativos com feedback
  - [ ] Configurar dashboard com gráficos de performance por intent
  - [ ] Implementar alertas para precisão <85% em qualquer intent
  - [ ] Adicionar análise de drift: mudanças no padrão de uso
  - [ ] Configurar relatórios semanais de performance para re-treinamento

---

## Dev Notes

### Arquitetura Relevante

**Arquivos Principais:**
- `src/lib/voiceCommandProcessor.ts` - Processador principal (já existe, precisa expansão)
- `src/hooks/useVoiceRecognition.ts` - Hook de reconhecimento (integração)
- `src/components/voice/VoiceDashboard.tsx` - Interface de feedback

**Novos Arquivos Necessários:**
- `src/lib/nlu/nluEngine.ts` - Motor principal de NLU
- `src/lib/nlu/intentClassifier.ts` - Classificador de intenções
- `src/lib/nlu/entityExtractor.ts` - Extrator de entidades
- `src/lib/nlu/disambiguator.ts` - Sistema de desambiguação
- `src/data/utterances.json` - Dataset de expressões brasileiras

**Integrações:**
- tRPC procedures para dados financeiros contextuais
- Supabase para logging de interações e feedback
- Sistema de notificações para confirmações

### Framework NLU Especificado

**Bibliotecas Escolhidas:**
```bash
# Instalar dependências
bun add compromise natural stopwords-pt
bun add -d @types/natural
```

**Arquitetura do NLU Engine:**
```typescript
// src/lib/nlu/nluEngine.ts
interface NLUResult {
  intent: IntentType;
  confidence: number;
  entities: ExtractedEntity[];
  originalText: string;
  normalizedText: string;
  processingTime: number;
  requiresConfirmation: boolean;
}

interface ExtractedEntity {
  type: EntityType;
  value: string;
  normalizedValue: any;
  confidence: number;
  startIndex: number;
  endIndex: number;
}

enum IntentType {
  CHECK_BALANCE = 'check_balance',
  CHECK_BUDGET = 'check_budget',
  PAY_BILL = 'pay_bill',
  CHECK_INCOME = 'check_income',
  FINANCIAL_PROJECTION = 'financial_projection',
  TRANSFER_MONEY = 'transfer_money',
  UNKNOWN = 'unknown'
}

class NLUEngine {
  private intentClassifier: IntentClassifier;
  private entityExtractor: EntityExtractor;
  private cache: Map<string, NLUResult>;

  async processUtterance(text: string): Promise<NLUResult> {
    const startTime = Date.now();

    // 1. Normalizar texto
    const normalizedText = this.normalizeText(text);

    // 2. Classificar intenção
    const intentResult = await this.intentClassifier.classify(normalizedText);

    // 3. Extrair entidades
    const entities = await this.entityExtractor.extract(normalizedText, intentResult.intent);

    // 4. Determinar se precisa confirmação
    const requiresConfirmation = this.needsConfirmation(intentResult, entities);

    return {
      intent: intentResult.intent,
      confidence: intentResult.confidence,
      entities,
      originalText: text,
      normalizedText,
      processingTime: Date.now() - startTime,
      requiresConfirmation
    };
  }
}
```

**Fluxo de Processamento:**
1. Normalização do texto transcrito
2. Classificação de intenção com scoring
3. Extração de entidades relevantes
4. Validação e desambiguação se necessário
5. Execução do comando ou solicitação de clarificação

### Testing

**Localização:** `src/test/nlu/`
**Frameworks:** Vitest para lógica, Playwright para fluxos E2E
**Datasets de Teste:**
- 500+ expressões categorizadas por intent
- Casos ambíguos e edge cases
- Variações regionais brasileiras
- Comandos com entidades faltantes

**Métricas de Qualidade:**
- Precisão por intent ≥90%
- Recall por intent ≥85%
- F1-score geral ≥87%
- Latência média <200ms

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*