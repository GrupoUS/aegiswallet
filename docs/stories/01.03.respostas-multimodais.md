# Story 01.03: Orquestração de Respostas Multimodais

## Status
**Current Status:** Draft  
**Epic:** 01 - Voice Interface Foundation  
**Priority:** High  
**Estimated Effort:** 4 days  
**Dependencies:** TTS provider, frontend voice components, supabase data

---

## Story

**As a** usuário do AegisWallet,  
**I want** receber respostas completas que combinam voz natural, texto formatado e feedback visual,  
**so that** eu tenha uma experiência rica e acessível, podendo entender as informações mesmo em ambientes barulhentos ou com limitações auditivas.

---

## Acceptance Criteria

1. [ ] Gerar resposta em voz natural com SSML e TTS brasileiro
2. [ ] Exibir resumo textual com dados financeiros formatados (R$, datas brasileiras)
3. [ ] Fornecer feedback visual nos componentes VoiceIndicator/VoiceResponse
4. [ ] Garantir fallback textual acessível para usuários com deficiência auditiva
5. [ ] Métricas de satisfação do usuário coletadas após resposta
6. [ ] Tempo total de resposta (voz + visual) <800ms
7. [ ] Suporte a modo somente-texto configurável pelo usuário
8. [ ] Formatação consistente de valores monetários e datas brasileiras

---

## Tasks / Subtasks

- [ ] **Sistema de Text-to-Speech Brasileiro** (AC: 1)
  - [ ] Integrar provedor TTS com vozes brasileiras naturais
  - [ ] Implementar SSML para ênfase e pausas contextuais
  - [ ] Configurar velocidade e tom de voz personalizáveis
  - [ ] Adicionar cache de áudio para respostas frequentes
  - [ ] Implementar fallback para TTS do navegador

- [ ] **Formatação de Dados Financeiros** (AC: 2, 8)
  - [ ] Criar utilitários de formatação monetária brasileira
  - [ ] Implementar formatação de datas (DD/MM/YYYY)
  - [ ] Adicionar formatação de números grandes (milhares, milhões)
  - [ ] Criar templates de resposta para cada tipo de comando
  - [ ] Implementar localização de mensagens de erro

- [ ] **Componentes de Feedback Visual** (AC: 3)
  - [ ] Expandir VoiceIndicator com estados de resposta
  - [ ] Atualizar VoiceResponse para exibir dados estruturados
  - [ ] Adicionar animações de transição entre estados
  - [ ] Implementar indicadores de progresso para operações longas
  - [ ] Criar componentes de visualização de dados financeiros

- [ ] **Acessibilidade e Fallbacks** (AC: 4, 7)
  - [ ] Implementar modo somente-texto nas configurações
  - [ ] Adicionar suporte a leitores de tela (ARIA labels)
  - [ ] Criar alternativas visuais para feedback sonoro
  - [ ] Implementar alto contraste para indicadores visuais
  - [ ] Adicionar opções de tamanho de fonte aumentado

- [ ] **Coleta de Feedback e Métricas** (AC: 5, 6)
  - [ ] Implementar sistema de rating pós-resposta (1-5 estrelas)
  - [ ] Adicionar coleta de feedback textual opcional
  - [ ] Configurar métricas de tempo de resposta
  - [ ] Implementar A/B testing para diferentes formatos de resposta
  - [ ] Criar dashboard de satisfação por tipo de comando

---

## Dev Notes

### Arquitetura Relevante

**Componentes Existentes para Expansão:**
- `src/components/voice/VoiceIndicator.tsx` - Indicador visual de status
- `src/components/voice/VoiceResponse.tsx` - Componente de resposta
- `src/components/voice/VoiceDashboard.tsx` - Dashboard principal
- `src/components/accessibility/AccessibilityProvider.tsx` - Contexto de acessibilidade

**Novos Arquivos Necessários:**
- `src/lib/tts/textToSpeechService.ts` - Serviço de TTS
- `src/lib/formatters/brazilianFormatters.ts` - Formatadores brasileiros
- `src/components/voice/ResponseTemplates.tsx` - Templates de resposta
- `src/hooks/useMultimodalResponse.ts` - Hook para respostas multimodais

**Integrações:**
- Provedor TTS (Google, Azure, ou Amazon Polly)
- Sistema de configurações do usuário (Supabase)
- Analytics para métricas de satisfação

### Padrões de Resposta

**Estrutura de Resposta Multimodal:**
```typescript
interface MultimodalResponse {
  text: string;
  speech: string;
  visual: {
    type: 'balance' | 'transaction' | 'alert';
    data: any;
    formatting: BrazilianFormatting;
  };
  accessibility: {
    ariaLabel: string;
    screenReaderText: string;
  };
}
```

**Templates de Voz por Comando:**
- Saldo: "Seu saldo atual é de [valor] reais"
- Orçamento: "Você pode gastar [valor] reais este mês"
- Boletos: "Você tem [quantidade] contas para pagar"
- Etc.

### Testing

**Localização:** `src/test/voice/multimodal/`
**Frameworks:** Vitest + Testing Library para componentes
**Testes Específicos:**
- Renderização de diferentes tipos de resposta
- Acessibilidade com screen readers simulados
- Performance de TTS e formatação
- Fallbacks quando TTS falha
- Formatação correta de valores brasileiros

**Métricas de Qualidade:**
- Tempo de resposta total <800ms
- Taxa de sucesso TTS >98%
- Satisfação média >4.0/5.0
- Cobertura de acessibilidade 100%

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0.0 | Criação inicial da story | PM Agent "John" |

---

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

---

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*